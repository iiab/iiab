- name: detected_network
  include_tasks: detected_network.yml

#- name: "Set 'no_net_restart: True' if discovered_wireless_iface == iiab_wan_iface"
- name: "Set 'no_net_restart: True' if has_wifi_gateway is defined"
  set_fact:
    no_net_restart: True    # 2020-09-12:
    # 0-init/defaults/main.yml - default boolean value of False
    # network/tasks/main.yml - changes flag based on conditional present
    # Var is currently used in 9 subsequent files, to suppress restarting of
    # hostapd, dnsmasq and/or other networking service in computed_services.yml,
    # debian.yml, detected_network.yml, down-debian.yml, netplan.yml,
    # NM-debian.yml, restart.yml, rpi_debian.yml, sysd-netd-debian.yml
  when: has_wifi_gateway is defined

- name: computed_network
  include_tasks: computed_network.yml

# 2022-07-22: @jvonau asks for this to be (1) BELOW computed_network.yml
# (what goes into iiab-hotspot-on|off depends on can_be_ap and wifi_up_down)
# AND (2) ABOVE install.yml for some reason?  REQUIREMENT: Admin Console reads
# iiab_network_mode from /etc/iiab/iiab.ini + uses /usr/bin/iiab-hotspot-on|off
- name: Install /usr/bin/iiab-hotspot-on|off from template (root:root by default)
  template:
    src: "{{ item }}"
    dest: /usr/bin/
    mode: 0755
  with_items:
    - hostapd/iiab-hotspot-on
    - hostapd/iiab-hotspot-off

- name: Install network packages (including many WiFi tools, and also iptables-persistent for firewall)
  include_tasks: install.yml
  when: network_install and network_installed is undefined


- name: Configuring Network if enabled
  block:

  # 2022-07-22: Is './runrole --reinstall network' the new way to make this run?
  #- name: (Re)Install Squid
  #  include_tasks: squid.yml
  #  when: squid_install and FQDN_changed and iiab_stage|int == 9

  #### Start services
  - name: computed_services
    include_tasks: computed_services.yml
  - name: enable_services
    include_tasks: enable_services.yml
  #### End services

  #### Start network layout

  - name: NetworkManager in use
    include_tasks: NM-debian.yml
    when: network_manager_active

  # 2025-03-21 #3961 WARNING: RasPiOS standard wifi firmware for RPi 4, 5, 500
  # [ /lib/firmware/cypress/cyfmac43455-sdio-standard.bin i.e. BCM4345/6 wl0:
  # Aug 29 2023 01:47:08 version 7.45.265 (28bca26 CY) FWID 01-b677b91b ]
  # crashes OFTEN during NM-debian.yml restart of NetworkManager.  Similarly,
  # 'nmcli radio wifi off' OFTEN triggers crashes on bare RasPiOS, as seen by:
  # watch -n.1 "iw reg get; iw dev; echo; dmesg | grep Firmware:"

  # PR #3965 MITIGATION: Deferring the setting of wifi country code (moved from
  # just above NM-debian.yml, to just below) is NOT a complete solution, but
  # this is just one of several helpful mitigations, evolving to make IIAB
  # installs much more reliable.

  # 2024-12-18: As `rfkill unblock wifi` formerly in rpi_debian.yml wasn't enough, especially with NM (NetworkManager)
  - name: Run 'raspi-config nonint do_wifi_country {{ host_country_code }}' (using var host_country_code) to unblock WiFi, if RasPiOS
    command: raspi-config nonint do_wifi_country {{ host_country_code }}
    when: is_raspbian
  
  - name: systemd-networkd in use
    include_tasks: sysd-netd-debian.yml
    when: systemd_networkd_active
    #when: systemd_networkd_active and not network_manager_active    # 2023-10-11: NOT the right way to solve #3657 (systemd-resolved issue on RasPiOS 12+) as this would damage Ubuntu/Mint.

  # 2023-10-11: Should rpi_debian.yml go away in future, now that RasPiOS Bookworm uses NetworkManager?
  - name: Raspbian can use dhcpcd only with no N-M or SYS-NETD active
    include_tasks: rpi_debian.yml
    when: is_raspbian and not network_manager_active

  - name: Not RPi, Not NetworkManager, Not systemd-networkd in use
    include_tasks: debian.yml
    when: not is_raspbian and not network_manager_active and not systemd_networkd_active
    #when: (not is_raspbian and not network_manager_active and not systemd_networkd_active and is_debuntu) or is_ubuntu_16
  #### end network layout

  - name: hostapd
    include_tasks: hostapd.yml

  - name: Restart services (and clone wifi to create ap0 if necessary)
    include_tasks: restart.yml

  # end block
  when: network_installed is defined and network_enabled

- name: Select RPi firmware mode
  include_role:
    name: firmware
  when: rpi_model != "none"


- name: Create {{ iiab_etc_path }}/install-flags/iiab-network-complete on second pass of network role
  file:
    path: "{{ iiab_etc_path }}/install-flags/iiab-network-complete"
    state: touch
  when: iiab_stage|int == 9
