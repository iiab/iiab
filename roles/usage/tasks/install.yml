
- name: make the required directories for usage page
  file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
  with_items:
    - '{{ usage_path }}/usage'
    - '{{ usage_path }}/usage/assets/'


- name: Fetch the javascript bundle usage page
# At this point, fetches from github.com/iiab/iiab-factory from {{ usage_branch }} branch
  get_url:
     url: "{{ usage_repo_url }}/{{ usage_branch }}/box/generic/fieldback/{{ item.src }}"
     dest: '{{ usage_path }}/usage/{{ item.dest }}'
  with_items:
      - { "src": "build/index.html", "dest":"index.html"}
      - { "src": "build/report-bundle.js", "dest": "report-bundle.js"}
      - { "src": "build/report-bundle.js.map", "dest": "report-bundle.js.map"}
      - { "src": "assets/Chart.bundle.js", "dest": "assets/Chart.bundle.js"}
      - { "src": "assets/Chart.css", "dest": "assets/Chart.css"}
      - { "src": "assets/moment.js", "dest": "assets/moment.js"}
      - { "src": "usage.css", "dest": "usage.css"}
      - { "src": "select.php ", "dest": "select.php"}
      - { "src": "fetch.php ", "dest": "fetch.php"}
      - { "src": "csv.php ", "dest": "csv.php"}

- name: Copy a scripts to accumulate WiFi data into database
  get_url:
      url: "{{ usage_repo_url }}/{{ usage_branch }}/box/generic/fieldback/{{ item }}"
      dest: /usr/bin/
      mode: 0755
  with_items:
      - iiab-wifidata.py


# RECORD USAGE AS INSTALLED

- name: "Add 'usage_installed: True' to {{ iiab_state_file }}"
  lineinfile:
    path: "{{ iiab_state_file }}"    # /etc/iiab/iiab_state.yml
    regexp: '^usage_installed'
    line: 'usage_installed: True'
