- name: Cham - Create streaming root directory
  file: 
    path: "{{ streaming_root }}"
    state: directory
    owner: root
    group: root
    mode: 0777

- name: Cham - Create hls directory
  file: 
    path: "{{ streaming_root }}/{{ hls_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0777

- name: Cham - Create flv directory
  file: 
    path: "{{ streaming_root }}/{{ flv_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0777

- name: Cham - Create recordings directory
  file: 
    path: "{{ streaming_root }}/{{ recordings_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0777

- name: Cham - Link to public recordings directory
  file:
    src: "{{ streaming_root }}/{{ recordings_dir }}"
    dest: "{{ doc_root }}/local_content/{{ recordings_dir }}"
    state: link
  when: public_recordings | bool 

- name: Cham - Install nginx dependencies
  package:
    name:
      - build-essential
      - libpcre3
      - libpcre3-dev
      - zlib1g
      - zlib1g-dev
      - libssl-dev
    state: latest

- name: Cham - Install ffmpeg to allow transcoding of videos
  package:
    name:
      - ffmpeg
    state: latest

- name: Cham - Download nginx source
  get_url:
    url: "{{ nginx_url }}/{{ nginx_src_file }}"
    dest: "{{ downloads_dir }}/{{ nginx_src_file }}"
    timeout: "{{ download_timeout }}"
  when: internet_available | bool

- name: Cham - Download nginx-rtmp-module source
  get_url:
    url: "{{ nginx_rtmp_module_url }}/{{ nginx_rtmp_module_src_file }}"
    dest: "{{ downloads_dir }}/{{ nginx_rtmp_module_src_file }}"
    timeout: "{{ download_timeout }}"
  when: internet_available | bool

- name: Cham - Create nginx source directory
  file: 
    path: "{{ downloads_dir }}/{{ nginx_src_dir }}"
    state: directory

- name: Cham - Extract nginx source
  unarchive: 
    src: "{{ downloads_dir }}/{{ nginx_src_file }}"
    dest: "{{ downloads_dir }}/{{ nginx_src_dir }}"
    owner: root
    group: root
    extra_opts: [--strip-components=1]

- name: Cham - Extract nginx-rtmp-module source
  unarchive: 
    src: "{{ downloads_dir }}/{{ nginx_rtmp_module_src_file }}"
    dest: "{{ downloads_dir }}/"
    owner: root
    group: root

- name: Cham - Nginx - run configure
  command: "./configure --add-module={{ downloads_dir }}/{{ nginx_rtmp_module_src_dir }}"
  args:
    chdir: "{{ downloads_dir }}/{{ nginx_src_dir }}"

- name: Cham - Nginx - make
  command: make 
  args:
    chdir: "{{ downloads_dir }}/{{ nginx_src_dir }}"

- name: Cham - Nginx - make install
  command: make install
  args:
    chdir: "{{ downloads_dir }}/{{ nginx_src_dir }}"

- name: Cham - Copy nginx init script
  template:
    src: nginx
    dest: /etc/init.d/nginx
    owner: root
    group: root
    mode: 0755

- name: Cham - Update rc.d after copying init script
  command: update-rc.d nginx defaults

- name: Cham - Copy nginx service configuration
  template:
    src: nginx.conf.j2
    dest: /usr/local/nginx/conf/nginx.conf
    owner: root
    group: root
    mode: 0755

- name: Cham - Configure nginx cross-domain
  template:
    src: crossdomain.xml
    dest: /usr/local/nginx/html/crossdomain.xml
    owner: root
    group: root
    mode: 0755

- name: Cham - Copy rtmp stat.xsl
  copy:
    src: "{{ downloads_dir }}/{{ nginx_rtmp_module_src_dir }}/stat.xsl"
    dest: /usr/local/nginx/html/
    owner: root
    group: root
    mode: 0755

- name: Cham - Download web-interface to /opt/iiab/downloads
  get_url:
    url: "{{ cham_url }}/{{ cham_src_file }}"
    dest: "{{ downloads_dir }}/{{ cham_src_file }}"
    timeout: "{{ download_timeout }}"
  when: internet_available | bool

- name: Cham - Extract demo video page to nginx web root
  unarchive: 
    src: "{{ downloads_dir }}/{{ cham_src_file }}"
    dest: "/usr/local/nginx/html/"
    owner: root
    group: root
    extra_opts: [--strip-components=1]

- name: Cham - Restart nginx
  systemd:
    name: nginx
    state: restarted
