- name: 'Install packages: php{{ php_version }}-intl, php{{ php_version }}-mbstring'
  package:
    name:
      - "php{{ php_version }}-intl"
      - "php{{ php_version }}-mbstring"
    state: present
  #tags:
  #  - download

- name: Download {{ mediawiki_download_base_url }}/{{ mediawiki_src }} to {{ downloads_dir }}
  get_url:
    url: "{{ mediawiki_download_base_url }}/{{ mediawiki_src }}"
    dest: "{{ downloads_dir }}"
    timeout: "{{ download_timeout }}"
    #force: yes
    #backup: yes
  when: internet_available | bool

- name: Unpack it to permanent location {{ mediawiki_abs_path }}
  unarchive:
    src: "{{ downloads_dir }}/{{ mediawiki_src }}"
    dest: "{{ mediawiki_install_path }}"
    owner: root
    group: "{{ apache_user }}"
    mode: 0755
    keep_newer: yes

- name: Create symlink mwlink from docroot to {{ mediawiki_abs_path }}
  file:
    src: "{{ mediawiki_abs_path }}"
    dest: "{{ doc_root }}/mwlink"
    state: link

- name: Install /etc/{{ apache_config_dir }}/mediawiki.conf from template, for http://box{{ mediawiki_url }}
  template:
    src: mediawiki.conf.j2
    dest: "/etc/{{ apache_config_dir }}/mediawiki.conf"

# Install {{ nginx_config_dir }}/mediawiki-nginx.conf from template in enable.yml

- name: "Add 'mediawiki_installed: True' to {{ iiab_state_file }}"
  lineinfile:
    dest: "{{ iiab_state_file }}"    # /etc/iiab/iiab_state.yml
    regexp: '^mediawiki_installed'
    line: 'mediawiki_installed: True'
