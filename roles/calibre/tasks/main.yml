- name: Get Calibre setup file
# the installer works for intel fedora, and Centos, and deals with dependencies
  get_url:
    url="{{ calibre_src_url }}"
    dest="{{ downloads_dir }}/calibre-installer.py"
    mode=0755
  when: ansible_distribution == "CentOS"

- name: Install Calibre (CentOS)
  shell: "{{ downloads_dir }}/calibre-installer.py >> /dev/null"
  args:
    creates: /usr/bin/calibre-uninstall
  when: calibre_install and ansible_distribution == 'CentOS'

- name: Install Calibre (OS's other than CentOS)
# the fedora rpm arm version, though older, takes care of dependencies, and exists
  package:  name={{ item }}
            state=present
  with_items:
    - calibre
  when: calibre_install and ansible_distribution != 'CentOS'

- name: Create calibre-serve.service and calibre.conf
  template: backup=no
            src={{ item.src }}
            dest={{ item.dest }}
            owner=root
            group=root
            mode={{ item.mode }}
  with_items:
    - { src: 'calibre-serve.service.j2', dest: '/etc/systemd/system/calibre-serve.service', mode: '0644'}
    - { src: 'calibre.conf', dest: '/etc/{{ apache_config_dir }}', mode: '0644'}
  when: calibre_install

- name: Create the link for sites-enabled
  file: src=/etc/apache2/sites-available/calibre.conf
        dest=/etc/apache2/sites-enabled/calibre.conf
        state=link
  when: is_debuntu and calibre_enabled

- name: Enable Calibre server
  service: name=calibre-serve
           enabled=yes
           state=started
  #async: 900
  #poll: 5
  when: calibre_enabled

- name: Disable Calibre server
  service: name=calibre-serve
           enabled=no
           state=stopped
  when: not calibre_enabled

- name: Add 'calibre-serve' to service list
  ini_file: dest='{{ service_filelist }}'
            section=calibre
            option='{{ item.option }}'
            value='{{ item.value }}'
  with_items:
    - option: description
      value: '"Calibre epub book server"'
    - option: url
      value: "{{ calibre_src_url }}"
    - option: database
      value: "{{ calibre_dbpath }}"
    - option: port
      value: "{{ calibre_port }}"
    - option: enabled
      value: "{{ calibre_enabled }}"
