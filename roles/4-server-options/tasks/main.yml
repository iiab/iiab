# Server Options

- name: ...IS BEGINNING ==================================
  file:
    path: "{{ iiab_state_file }}"
    state: touch

- name: MYSQL setup
  include_role:
    name: mysql-enable
  tags: base, mysql

- name: Install named / BIND
  include_tasks: roles/network/tasks/named.yml
  when: named_install | bool
  tags: base, named, network, domain

- name: Installing dhcpd
  include_tasks: roles/network/tasks/dhcpd.yml
  when: dhcpd_install | bool
  tags: base, dhcpd, network, domain

- name: Install Squid (and DansGuardian if dansguardian_install)
  include_tasks: roles/network/tasks/squid.yml
  when: squid_install | bool
  tags: base, squid, network, domain

- name: Install iiab python files
  include_tasks: roles/2-common/tasks/pylib.yml

# MANDATORY SO PERHAPS THIS BELONGS IN 3-BASE-SERVER ?
- name: HOMEPAGE
  include_role:
    name: homepage
  # has no "when: XXXXX_install" flag
  tags: base, homepage

- name: Run /usr/bin/iiab-refresh-wiki-docs (scraper script) to create http://box/info offline documentation.  (This script was installed at the beginning of Stage 3 = roles/3-base-server/tasks/main.yml, which ran Apache playbook = roles/httpd/tasks/main.yml)
  command: /usr/bin/iiab-refresh-wiki-docs
  when: internet_available and not nodocs

- name: USB-LIB
  include_role:
    name: usb-lib
  when: usb_lib_install | bool
  tags: usb-lib

- name: OSM-VECTOR-MAPS
  include_role:
    name: osm-vector-maps
  tags: osm, maps

- name: Configure NGINX
  include_role:
    name: nginx
  when: nginx_install
  tags: base, nginx

- name: Configure Apache systemd service ({{ apache_service }})
  include_role:
    name: httpd-enable
  when: apache_enabled
  tags: base, httpd

- name: Recording STAGE 4 HAS COMPLETED ==================
  lineinfile:
    dest: "{{ iiab_env_file }}"
    regexp: '^STAGE=*'
    line: 'STAGE=4'
    state: present
