# Custom proot NGINX service handler due the lack of systemd on termux-android devices.

- name: Validate nginx config (proot)
  ansible.builtin.shell: nginx -t
  register: _nginx_t
  changed_when: false

- name: Abort if validation failed (proot)
  ansible.builtin.fail:
    msg: "nginx -t failed: {{ _nginx_t.stderr | default(_nginx_t.stdout) }}"
  when: _nginx_t.rc != 0

- name: Stop & wait until nginx exits (proot)
  ansible.builtin.shell:
    cmd: |
      if pgrep -x nginx >/dev/null 2>&1; then
        nginx -s quit || pkill -TERM -x nginx || true
        # wait until finish
        for i in $(seq 1 10); do
          pgrep -x nginx >/dev/null 2>&1 || break
          sleep 1
        done
      fi
    executable: /bin/bash
  when: _nginx_t.rc == 0

- name: Start nginx (proot)
  ansible.builtin.shell:
    cmd: "nohup nginx >/tmp/nginx.log 2>&1 &"
    executable: /bin/bash
  when: _nginx_t.rc == 0

- name: Wait for HTTP port {{ nginx_port }}
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ nginx_port }}"
    timeout: 10
