---
# roles/pdsm_services/tasks/main.yml
- block:
    - name: Ensure base PDSM dirs exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /usr/local/pdsm
        - /usr/local/pdsm/lib
        - /usr/local/pdsm/services-available
        - /usr/local/pdsm/services-enabled

    - name: Install pdsm profile script (/etc/profile.d/pdsm.sh)
      ansible.builtin.copy:
        src: "pdsm/etc_profile.d/pdsm.sh"
        dest: "/etc/profile.d/pdsm.sh"
        mode: "0644"

    - name: Install pdsm CLI (/usr/local/bin/pdsm)
      ansible.builtin.copy:
        src: "pdsm/usr_local_bin/pdsm"
        dest: "/usr/local/bin/pdsm"
        mode: "0755"

    - name: Install pdsm common library
      ansible.builtin.copy:
        src: "pdsm/usr_local_pdsm/lib/pdsm-common.sh"
        dest: "/usr/local/pdsm/lib/pdsm-common.sh"
        mode: "0644"

    - name: Install PDSM service scripts into services-available
      ansible.builtin.copy:
        src: "pdsm/usr_local_pdsm/services-available/{{ item }}"
        dest: "/usr/local/pdsm/services-available/{{ item }}"
        mode: "0755"
      loop: "{{ pdsm_installed_services }}"

    - name: Enable PDSM default services, not all services are necessarily enabled
      ansible.builtin.shell: "pdsm enable {{ item }}"
      loop: "{{ pdsm_enabled_services }}"
  when: is_proot
