---
# proot-distro: sudo's defaults use_pty breaks interactive stdin (/dev/tty mismatch) which
# makes scripts hang at prompts waiting for a "y/n" answer. Disable PTY allocation for sudo.

- name: Make sure /etc/sudoers.d exists
  become: true
  file:
    path: /etc/sudoers.d
    state: directory
    owner: root
    group: root
    mode: '0750'

- name: Install /etc/sudoers.d/iiab-no-pty (proot only)
  become: true
  copy:
    dest: /etc/sudoers.d/iiab-no-pty
    owner: root
    group: root
    mode: '0440'
    content: |
      # IIAB on Android / proot: avoid sudo PTY allocation, it breaks interactive prompts
      Defaults !use_pty
    # Validate if visudo exists; otherwise skip validation safely.
    validate: "/bin/sh -c 'command -v visudo >/dev/null 2>&1 && visudo -cf %s || true'"
