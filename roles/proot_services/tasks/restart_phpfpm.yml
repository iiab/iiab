# roles/proot_services/tasks/restart_phpfpm.yml
- name: Restart php-fpm (proot)
  ansible.builtin.shell: |
    set -e

    # Pick a php-fpm binary (prefer versioned, then generic)
    PHPFPM="$(command -v php-fpm{{ php_version }} || command -v php-fpm || true)"
    if [ -z "$PHPFPM" ]; then
      echo "[php-fpm] binary not found" >&2
      exit 1
    fi

    # Minimal config & socket paths (Debian/Ubuntu defaults)
    CONF="/etc/php/{{ php_version }}/fpm/php-fpm.conf"
    [ -f "$CONF" ] || CONF="/etc/php-fpm.conf"
    SOCK="/run/php/php{{ php_version }}-fpm.sock"
    mkdir -p "$(dirname "$SOCK")" /var/log/php

    # Stop any existing php-fpm quickly (ignore errors if not running)
    pkill -TERM php-fpm >/dev/null 2>&1 || true
    sleep 0.5
    pkill -KILL php-fpm >/dev/null 2>&1 || true

    # Remove stale socket (if master died and left it behind)
    rm -f "$SOCK" || true

    # Start daemonized and wait for the socket to appear
    "$PHPFPM" -y "$CONF" -D >>/var/log/php/fpm-restarts.log 2>&1 || {
      echo "[php-fpm] failed to start — last log:"
      tail -n 100 /var/log/php/fpm-restarts.log || true
      exit 1
    }

    for i in $(seq 1 40); do [ -S "$SOCK" ] && break; sleep 0.25; done
    [ -S "$SOCK" ] || {
      echo "[php-fpm] socket not found at $SOCK — last log:"
      tail -n 120 /var/log/php/fpm-restarts.log || true
      exit 1
    }

    echo "[php-fpm] OK | bin=$PHPFPM conf=$CONF sock=$SOCK"
  args:
    executable: /bin/bash
  register: php_fpm_restart
  changed_when: true
  when: is_proot

- name: Short debug (php-fpm restart)
  debug:
    var: php_fpm_restart.stdout
  when: is_proot
