#!/bin/sh
# /usr/local/pdsm/services-available/wuzapi
# PDSM service wrapper for Wuzapi

PDSM_COMMON="/usr/local/pdsm/lib/pdsm-common.sh"
[ -r "$PDSM_COMMON" ] && . "$PDSM_COMMON"

SERVICE_NAME="wuzapi"
PIDFILE="/run/rapidpro/wuzapi.pid"
LOGFILE="/var/log/rapidpro/wuzapi.log"

export WUZAPI_ADMIN_TOKEN="{{ wuzapi_admintoken }}"

mkdir -p /run/rapidpro
mkdir -p /var/log/rapidpro

running() {
  [ -s "$PIDFILE" ] || return 1
  pid="$(cat "$PIDFILE" 2>/dev/null)"
  [ -n "$pid" ] || return 1
  kill -0 "$pid" 2>/dev/null || pgrep -u "{{ iiab_admin_user }}" -f "/usr/local/bin/wuzapi" >/dev/null
}

start() {
  if running; then
    echo "[pdsm:$SERVICE_NAME] already running"
    return 0
  fi

  echo "[pdsm:$SERVICE_NAME] starting..."
  export USER={{ iiab_admin_user }}

  # Use screen for persistence
  screen -dmS "$SERVICE_NAME" bash -c "\
    cd {{ wuzapi_dir }} && ./wuzapi \
      -port {{ wuzapi_port }} \
      -admintoken \"{{ wuzapi_admintoken }}\" \
      -logtype json \
      -wadebug {{ wuzapi_debug }} \
      >>\"$LOGFILE\" 2>&1"
  
  sleep 1
  pgrep -u "$USER" -f "/usr/local/bin/wuzapi" > "$PIDFILE"

  for i in $(seq 1 10); do
    if running; then
      echo "[pdsm:$SERVICE_NAME] started"
      return 0
    fi
    sleep 1
  done

  echo "[pdsm:$SERVICE_NAME] failed to start" >&2
  return 1
}

stop() {
  if ! running; then
    echo "[pdsm:$SERVICE_NAME] already stopped"
    return 0
  fi

  echo "[pdsm:$SERVICE_NAME] stopping..."
  pid="$(cat "$PIDFILE" 2>/dev/null)"
  if [ -n "$pid" ]; then
    kill "$pid" 2>/dev/null || true
    sleep 2
    if running; then
       kill -9 "$pid" 2>/dev/null || true
    fi
    screen -X -S "$SERVICE_NAME" quit >/dev/null 2>&1 || true
    rm -f "$PIDFILE"
  fi
  echo "[pdsm:$SERVICE_NAME] stopped"
  return 0
}

status() {
  if running; then
    echo "[pdsm:$SERVICE_NAME] running"
    return 0
  fi
  echo "[pdsm:$SERVICE_NAME] not running"
  return 3
}

case "$1" in
  start|stop|restart|status) "$1" ;;
  *) echo "Usage: $0 {start|stop|restart|status}" >&2; exit 1 ;;
esac
