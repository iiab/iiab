#!/bin/sh
# Simple PDSM service wrapper for Kolibri

SERVICE_NAME="kolibri"
PDSM_COMMON="/usr/local/pdsm/lib/pdsm-common.sh"
[ -r "$PDSM_COMMON" ] && . "$PDSM_COMMON"

# Adjust KOLIBRI_HOME to match your IIAB/Termux/proot layout
export KOLIBRI_HOME="/library/kolibri/"

KOLIBRI_BIN="$(command -v kolibri || echo kolibri)"

running() {
  # NOTE: if `ps aux | grep $SERVICE_NAME` shows nothing, this should fail too.
  pgrep -x $SERVICE_NAME >/dev/null 2>&1
}

start() {
  if running; then
    echo "[pdsm:$SERVICE_NAME] already running"
    return 0
  fi

  # Ensure nginx is up as a requirement
  require_service "nginx"

  "$KOLIBRI_BIN" start
}

stop() {
  if ! running; then
    echo "[pdsm:$SERVICE_NAME] already stopped"
    return 0
  fi

  # Kolibri already knows how to stop gracefully
  "$KOLIBRI_BIN" stop || true
}

status() {
  if "$KOLIBRI_BIN" status >/dev/null 2>&1; then
    echo "$SERVICE_NAME: running"
    exit 0
  else
    echo "$SERVICE_NAME: stopped"
    exit 1
  fi
}

case "$1" in
  start|stop|status)
    "$1"
    ;;
  restart)
    stop
    start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status}" >&2
    exit 1
    ;;
esac
