# Doing a proxy on unconventional ports requires to expand the 
# configuration to prevent leaving items out

# Ensure trailing slash
location = /kolibri {
    return 301 /kolibri/;
}

# API: browser hits /api/... but backend expects /kolibri/api/...
# Place this BEFORE any generic "location /" catch-all.
location ^~ /api/ {
    # tell the backend that its mounted on /kolibri
    proxy_set_header X-Script-Name      /kolibri;
    proxy_set_header X-Forwarded-Prefix /kolibri;

    proxy_redirect off;
    proxy_pass http://127.0.0.1:8009;   # NO trailing slash
}

# Static assets (CSS/JS/fonts, etc.)
location ^~ /static/ {
    proxy_redirect off;
    proxy_pass http://127.0.0.1:8009;   # NO trailing slash
}

# Content files (exports/resources)
location ^~ /content/ {
    proxy_redirect off;
    proxy_pass http://127.0.0.1:8009;   # NO trailing slash
}

# Main app under /kolibri/ (HTML, SPA routes)
location /kolibri/ {
    # Tell backend about the prefix
    proxy_set_header X-Script-Name /kolibri;

    # Rewrite absolute Location headers from backend
    proxy_redirect ~^/(.*)$             /kolibri/\$1;
    proxy_redirect http://127.0.0.1:8009/ /kolibri/;

    proxy_pass http://127.0.0.1:8009/;  # WITH trailing slash
}
