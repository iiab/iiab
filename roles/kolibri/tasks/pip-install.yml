- name: Remove kolibri deb if installed
  apt:
    name: kolibri
    state: "absent"

- name: Remove repo if present
  file:
    path: /etc/apt/sources.list.d/ppa_launchpad_net_learningequality_kolibri_ubuntu.list
    state: absent

- name: Remove previous virtual environment {{ kolibri_venv_path }}
  file:
    path: "{{ kolibri_venv_path }}"
    state: absent

# can't hurt but should be called in as a dependency
- name: Install prep for kolibri when NOT is_debian_13 or is_ubuntu_2504
  pip:
    name:
      - pip
      - wheel
      - setuptools
      - cgi
    virtualenv: "{{ kolibri_venv_path }}"
    virtualenv_command: python3 -m venv "{{ kolibri_venv_path }}"
    extra_args: "--no-cache-dir --prefer-binary"
  when: not (is_debian_13 or is_ubuntu_2504)

# package name change
- name: Install prep for kolibri when is_debian_13 or is_ubuntu_2504
  pip:
    name:
      - pip
      - wheel
      - setuptools
      - legacy-cgi
    virtualenv: "{{ kolibri_venv_path }}"
    virtualenv_command: python3 -m venv "{{ kolibri_venv_path }}"
    extra_args: "--no-cache-dir --prefer-binary"
  when: (is_debian_13 or is_ubuntu_2504)

- name: Install kolibri {{ kolibri_version_pip }} using pip
  pip:
    name: kolibri
    version: "{{ kolibri_version_pip }}"
    virtualenv: "{{ kolibri_venv_path }}"
    virtualenv_command: python3 -m venv "{{ kolibri_venv_path }}"
    extra_args: "--no-cache-dir --prefer-binary --ignore-requires-python"
  when: kolibri_version_pip_web is undefined

# use kolibri_version_pip_web: https://github.com/learningequality/kolibri/releases/download/<release> and set kolibri_version_pip
# and not the full path note v0.18.0-alpha1/kolibri-0.18.0a1-py2.py3-none-any.whl
- name: Install kolibri using {{ kolibri_version_pip_web }}/{{ kolibri_version_pip }}-py2.py3-none-any.whl
  pip:
    name: "{{ kolibri_version_pip_web }}/kolibri-{{ kolibri_version_pip }}-py2.py3-none-any.whl"
    virtualenv: "{{ kolibri_venv_path }}"
    virtualenv_command: python3 -m venv "{{ kolibri_venv_path }}"
    extra_args: "--no-cache-dir --prefer-binary --ignore-requires-python"
  when: kolibri_version_pip_web is defined

- name: Create {{ kolibri_exec_path }} symlink to {{ kolibri_venv_path }}/bin/kolibri
  file:
    src: "{{ kolibri_venv_path }}/bin/kolibri"
    dest: "{{ kolibri_exec_path }}"
    state: link
    force: true
