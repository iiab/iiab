# TODO - sqlite mode "only available for the python frontend" does that mean no gunicorn or what?

- name: Install packages for nominatim
  apt:
    name:
      # needed to compile wheel
      #- pkg-config    # virtual provides for pkgconf
      - pkgconf        # newest name
      - python3-dev    # header files
      - libicu-dev     # header files
      - g++            # compiler
      #- virtualenv    # replace with python -m venv in ansible

      # for sqlite backend
      - sqlite3
      - libsqlite3-mod-spatialite

      # I actually just need libspatialite, but the package has a different
      # name in different OS distros/versions. However libspatialite-dev seems
      # to be consistent, and has libspatialite as a dependency.
      #- libspatialite-dev
      - libspatialite8t64    # newest name of apt package for trixie and U24.04+

    state: present

- name: Create nominatim user
  user:
    name: "{{ nominatim_user }}"
    state: present
    shell: /bin/bash
    create_home: no
    home: "{{ nominatim_home }}"

- name: Create nominatium home and webserver directories with desired permissions
  file:
    path: "{{ nominatim_home }}/nominatim-project"
    state: directory
    mode: '0755'
    owner: "{{ nominatim_user }}"

- name: Download nominatim database
  include_tasks: download_large_file.yml
  vars:
    dest_base_path: "{{ maps_data_root }}"
  with_items: "{{ nominatim_data[maps_search_nominatim_db] }}"

- name: Select nominatim database
  file:
    src: "{{ maps_data_root }}/{{ nominatim_data[maps_search_nominatim_db] }}"
    dest: "{{ maps_data_root }}/{{ nominatim_db_symlink_name }}"
    state: link

- name: Set up nominatim virtual environment {{ nominatim_venv }}
  pip:
    name:
      - aiosqlite
      - psycopg[binary]
      - nominatim-db
      - falcon
      - uvicorn
      - gunicorn
      - nominatim-api
    virtualenv: "{{ nominatim_venv }}"
    virtualenv_site_packages: no
    virtualenv_command: python3 -m venv "{{ nominatim_venv }}"
    extra_args: "--no-cache-dir --prefer-binary"
  become: yes
  become_user: "{{ nominatim_user }}"

- name: Install nominatim.service for systemd
  template:
    src: nominatim.service.j2
    dest: "/etc/systemd/system/nominatim.service"

- name: Install nominatim.socket for systemd
  template:
    src: nominatim.socket.j2
    dest: "/etc/systemd/system/nominatim.socket"

- name: Make nominatim conf directory (0755 by default)
  file:
    path: "/etc/systemd/system/nominatim.service.d"
    state: directory
    # mode: 0755

- name: Make nominatim log directory (0755 by default)
  file:
    path: "/var/log/nominatim"
    state: directory
    # mode: 0755
    owner: "www-data"

# Set environmental variables for nominatim.
- name: Install nominatim-env.conf for systemd
  template:
    src: nominatim-env.conf.j2
    dest: "/etc/systemd/system/nominatim.service.d/nominatim-env.conf"

- name: "Set 'nominatim_installed: True'"
  set_fact:
    nominatim_installed: True

- name: "Add 'nominatim_installed: True' to {{ iiab_state_file }}"
  lineinfile:
    path: "{{ iiab_state_file }}"    # /etc/iiab/iiab_state.yml
    regexp: '^nominatim_installed'
    line: 'nominatim_installed: True'
