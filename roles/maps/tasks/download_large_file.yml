# This will download large files using aria2c and meta4 files, and possibly
# torrent files.
#
# There are a few concerns for downloading such files which we may or may not be
# addressing at this time:
#
# Efficiency for implementers:
#
# * We will work toward supporting torrents, which may be faster than http.
# * aria2c will hopefully perform checksums in-memory (even if via disk cache)
#   during download. This will be faster than a full checksum after download,
#   which definitely requires disk read for large files.
# * Once files are fully downloaded and moved out of the temp directory, they
#   will not be downloaded on subsequent role runs. (This relates to "Updating
#   data" below)
#
# Integrity: aria2 will perform a sha256 checksum on each downloaded chunk of
# the file.
#
# Security: If there is a security concern down the line, we can provide PGP
# signatures for the meta4 and/or torrent files.
#
# Consistent versions: Data file versions may correspond to each other (e.g.
# vector map "extracts" should ideally match the low-res world map). This can
# be handled by putting a date in the file names of the data files. The date
# can be committed to the repository. However, at this time this concern is
# handled upstream of this file.
#
# Updating data: As of Dec 2025 this concern is out of scope. We assume that
# users will either figure it out on their own, or reinstall IIAB from scratch.
# That said, assuming we have dates in file names, this may be supported de
# facto, but we will not go out of our way to free up room by deleting the
# outdated files. (Perhaps adding automatic deletion will not be so hard once
# the time comes)
#
# TODO - files should be owned by www-data

- name: "Download {{ iiab_map_host_url }}/{{ item }} via .meta4 file"
  # cd to the temp directory so that the aria2c file, data file, and (perhaps
  # eventually) torrent file all end up there.
  shell: |
    set -euo pipefail

    cd /library/downloads/maps/

    aria2c \
        --connect-timeout="{{ download_timeout }}" \
        --log-level=warn \
        --console-log-level=warn \
        --summary-interval=0 \
        --show-console-readout=false \
        --download-result=hide \
        --follow-metalink=mem \
        --max-connection-per-server=4 \
        --file-allocation=falloc \
        --enable-http-pipelining=true \
        --seed-time=0 \
        "{{ iiab_map_host_url }}/{{ item }}.meta4"

    chmod 644 "{{ item }}"
    mv "{{ item }}" "{{ dest_path }}"
  args:
    executable: /bin/bash
    creates: "{{ dest_path }}"
  vars:
    # Where the file eventually goes
    dest_path: "{{ dest_base_path }}/{{ item }}"
