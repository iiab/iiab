# This will download large files using aria2c and meta4 files, and possibly
# torrent files.
#
# There are a few concerns for downloading such files which we may or may not be
# addressing at this time:
#
# Efficiency for implementers:
#
# * We will work toward supporting torrents, which may be faster than http.
# * Aria2c will hopefully perform checksums in-memory (even if via disk cache)
#   during download. This will be faster than a full checksum after download,
#   which definitely requires disk read for large files.
# * Once files are fully downloaded and moved out of the temp directory, they
#   will not be downloaded on subsequent role runs. (This relates to "Updating
#   data" below)
#
# Integrity: Aria2 will perform a sha256 checksum on each downloaded chunk of
# the file.
#
# Security: We will NOT commit sha256 checksums to the repository at this time,
# but that option remains open if the concern comes up. The best option may be
# to get the checksum of the meta4 file (and maybe the torrent file?)
#
# Consistent versions: Data file versions may correspond to each other (e.g.
# the "current" vector map should ideally match the search database). This can
# be handled by putting a date in the file names of the data files, perhaps
# committed to the repository. However, at this time this concern is handled
# upstream of this file.
#
# Updating data: As of Dec 2025 this concern is out of scope. We assume that
# users will either figure it out on their own, or reinstall IIAB from scratch.
# That said, assuming we have dates in file names, this may be supported de
# facto, but we will not go out of our way to free up room by deleting the
# outdated files. (Perhaps adding automatic deletion will not be so hard once
# the time comes)
#
# NOTE Already downloaded files show up as "skipped" instead of "ok".  I could
# fix this but we'll move to the download manager in due time anyway.
# TODO - files should be owned by www-data

- name: "Download {{ item.src_url }}"
  # cd to the temp directory so that the aria2c file, meta4 file, torrent file,
  # and data file all end up there.
  shell: |
    set -euo pipefail

    cd /library/downloads/maps/
    wget "{{ item.src_url }}.meta4"
    wget "{{ item.src_url }}.torrent"

    aria2c --metalink-file="{{ item.filename }}".meta4" --connect-timeout="{{ download_timeout }}"
    chmod 644 "{{ item.filename }}"
    mv "{{ item.filename }}" "{{ dest_path }}"

    rm "{{ item.filename }}".meta4
    rm "{{ item.filename }}".torrent
    rm "{{ item.filename }}".aria2
  args:
    executable: /bin/bash
  creates: "{{ dest_path }}"
  vars:
    # Where the file eventually goes
    dest_path: "{{ dest_base_path }}/{{ item.filename }}"
