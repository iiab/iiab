
#- name: Set kiwix source file name i686
#  set_fact:
#     kiwix_src_file: "kiwix-linux-i686.tar.bz2"
#     kiwix_src_bin_only: False
#  when: ansible_machine == "i686"

- name: Set kiwix source file name x86_64
  set_fact:
     kiwix_src_file: "kiwix-tools_linux64_2017-06-13.tar.gz"
     kiwix_src_bin_only: True
  when: ansible_machine == "x86_64"

- name: Set kiwix source file name armv7l
  set_fact:
     kiwix_src_file: "kiwix-tools_armhf_2017-06-13.tar.gz"
     kiwix_src_bin_only: True
  when: ansible_machine == "armv7l"

- name: See if kiwix is already configured
  stat: path=/etc/systemd/system/kiwix-serve.service
  register: kiwix_installed

- name: Get the kiwix software
  get_url: url="{{ iiab_download_url }}/{{ kiwix_src_file }}"  dest="{{ downloads_dir }}/{{ kiwix_src_file }}"
  when: kiwix_installed is defined and not kiwix_installed.stat.exists and internet_available

- include: kiwix_install.yml
  when: kiwix_installed is defined and not kiwix_installed.stat.exists and internet_available and kiwix_src_file is defined
  tags:
    - kiwix

- debug:  msg="WARNING kiwix source is not defined for your platform"
  when: not kiwix_src_file

- name: Enable kiwix-serve service
  service: name=kiwix-serve
           enabled=yes
           state=restarted
  when: kiwix_serve_enabled and kiwix_install

- name: Disable kiwix-serve service
  service: name=kiwix-serve
           enabled=no
           state=stopped
  when: not kiwix_serve_enabled and kiwix_install

- name: add kiwix to service list
  ini_file: dest='{{ service_filelist }}'
            section=kiwix-serve
            option='{{ item.option }}'
            value='{{ item.value }}'
  with_items:
    - option: name
      value: kiwix-serve
    - option: description
      value: '"kiwix-serve is a web server for zim files"'
    - option: kiwix_url
      value: "{{ kiwix_url }}"
    - option: kiwix_path
      value: "{{ kiwix_path }}"
    - option: kiwix_port
      value: "{{ kiwix_port }}"
    - option: iiab_zim_path
      value: "{{ iiab_zim_path }}"
    - option: kiwix_library_xml
      value: "{{ kiwix_library_xml }}"
    - option: kiwix_content_path
      value: "{{ kiwix_content_path }}"
    - option: enabled
      value: "{{ kiwix_serve_enabled }}"
