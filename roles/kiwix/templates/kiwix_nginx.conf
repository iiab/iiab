#limit_rate       50k;
#limit_rate_after 4k;
limit_conn_zone  $server_name        zone=perserver:1m;
limit_conn_zone  $binary_remote_addr zone=perip:1m;
limit_req_zone   $binary_remote_addr zone=four:1m rate=4r/s;

# Default server configuration, proxying requests to a kiwix-serve instance running on port 4201
#
# - add zim files to a library.xml, see http://www.kiwix.org/wiki/Kiwix-manage
# chown www-data *.zim library.xml
#
# - then start kiwix-serve (uses dropped privileges, like nginx itself):
# sudo -u www-data -g adm bash -c 'kiwix-serve --port=4201 --library library.xml &>/dev/null &'
#
server {
        # comment next three lines if connection or request rate limits are not needed
        limit_conn perserver 80;
        limit_conn perip 2;
        limit_req  zone=four burst=160;

        listen 80 default_server;
        #listen [::]:80 default_server;
        port_in_redirect off;

        server_name localhost kiwix;
        root /var/www/kiwix;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        error_page 400 404 =444 /dropconn_444;
        if ($request_method !~ ^(GET|HEAD)$) { return 444; }
        location = /dropconn_444 { return 444; }

        location = /favicon.ico {
          access_log off;
        }

        location = /robots.txt {
          access_log off;
          return 200 "User-Agent: *\nAllow: /index.html\nDisallow: /\n";
        }

        location ~ ^/([^/]*_all_|mw|random|search|skin|suggest)(.*)$ {
          # Choose these links as "Home" pages within respective wikis (adjust to your needs)
          rewrite ^(/wikipedia_de_all_nopic_2014-11)/$ $1/A/Würmeiszeit.html break;
          rewrite ^(/rezeptewiki_de_all_2014-06)/$ $1/A/html/L/ä/u/t/Läuterzucker.html break;

          # Skip logging certain uris (each tex formula is a png in zim files..)
          if ($request_uri ~ ^/(mw|random|search|skin|suggest)|\.(jpe?g|png)$) {
            access_log off;
          }

          proxy_pass        http://127.0.0.1:4201;
          proxy_set_header  X-Real-IP  $remote_addr;
        }
        rewrite ^/wp14/(.*)$ /wikipedia_de_all_nopic_2014-11/A/$1.html last;
        rewrite ^/wp/$ /_all_ last;

        location / {
          # For "Library" link of Kiwix Server to work (adjust HOSTNAME to your.setup.tld)
          valid_referers "~(localhost|kiwix|HOSTNAME|([0-9]+\.){3}[0-9]+)(|:[0-9]+)/[^/]*_all_";
          if ($invalid_referer != 1) {
            rewrite .* /_all_ last;
          }

          # First attempt to serve request as file, then
          # as directory, then fall back to displaying a 404.
          expires 0s;
          try_files $uri $uri/ =404;
        }
}
