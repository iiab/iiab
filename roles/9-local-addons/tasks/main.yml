# Local Add-ons

- name: ...IS BEGINNING ====================================
  meta: noop

# Is porting to Python 3 complete, and if so does this belong elsewhere?
- name: CAPTIVE PORTAL
  include_role:
    name: captiveportal
  when: captiveportal_install

- name: INTERNETARCHIVE
  include_role:
    name: internetarchive
  when: internetarchive_install

- name: MINETEST
  include_role:
    name: minetest
  when: minetest_install

- name: CALIBRE-WEB
  include_role:
    name: calibre-web
  when: calibreweb_install

# KEEP NEAR THE VERY END as this installs dependencies from Debian's 'testing' branch!
- name: CALIBRE
  include_role:
    name: calibre
  when: calibre_install

# Pulls in a large number of devel packages, via asterisk.yml -> 'install_prereq install'
# https://github.com/asterisk/asterisk/blob/master/contrib/scripts/install_prereq#L21-L35
- name: PBX - Asterisk & FreePBX
  include_role:
    name: pbx
  when: pbx_install

- name: "2021-06-27 TEMPORARY CODE TO INSTALL 'php-pear' UNTIL ADMIN CONSOLE DECLARES ITS OWN DEPENDENCY FOR: https://github.com/iiab/iiab-admin-console/blob/master/roles/cmdsrv/tasks/main.yml#L19"
  package:
    name: php-pear    # WARNING: this also drags in 'php{{ php_version }}-xml' (also installed by MediaWiki, Nextcloud, roles/pbx's FreePBX, WordPress) AND 'php{{ php_version }}-cgi' (also installed by roles/pbx's FreePBX)
    state: present
  when: admin_console_install

# Taken directly from 'iiab' has builtin checking via /etc/iiab/install-flags/ so safe to rerun. Now
# 'iiab' could just reference this new file like scripts/ansible or the file can live in iiab-factory
# use stage 9 so the stanzas from 'iiab' are used on the first pass, installs that add the kalite later
# will get picked up during iiab-configure or ICO in admin-console but not preset's runroles but could
# call this script to get the job done.
- name: Install kalite support if iiab-install was completed but kalite was not installed on the first pass during 'iiab'
  command scripts/kalite_support.sh
  when: iiab_stage == 9 and kalite_installed is defined

- name: Recording STAGE 9 HAS COMPLETED ====================
  lineinfile:
    path: "{{ iiab_env_file }}"
    regexp: '^STAGE=*'
    line: 'STAGE=9'
