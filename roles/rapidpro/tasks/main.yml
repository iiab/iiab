---
# This is the main task file for the rapidpro role.
# It orchestrates the entire installation and configuration process.

- name: Run installation tasks
  include_tasks: install.yml
  when: rapidpro_enabled

- name: Wait for PostgreSQL to be ready
  wait_for:
    port: 5432
    host: 127.0.0.1
    timeout: 300
  when: rapidpro_enabled

- name: Run configuration tasks
  include_tasks: configure.yml
  when: rapidpro_enabled

- name: Run nginx tasks
  include_tasks: nginx.yml
  when: rapidpro_enabled

- name: Mark rapidpro as installed
  lineinfile:
    path: /etc/iiab/iiab_state.yml
    line: "rapidpro_installed: true"
    create: yes
  become: yes
