---
# This file will contain all the configuration tasks for RapidPro.

- name: Create PostgreSQL user
  postgresql_user:
    name: "{{ rapidpro_db_user }}"
    password: "{{ rapidpro_db_pass }}"
  become: yes
  become_user: postgres

- name: Create PostgreSQL database
  postgresql_db:
    name: "{{ rapidpro_db_name }}"
    owner: "{{ rapidpro_db_user }}"
  become: yes
  become_user: postgres

- name: Enable PostgreSQL extensions
  # The 'db' parameter is used for compatibility with older versions of the community.postgresql collection.
  # It should be changed to 'database' when the collection is updated to a version that supports it.
  postgresql_ext:
    name: "{{ item }}"
    db: "{{ rapidpro_db_name }}"
    login_db: postgres
  loop:
    - postgis
    - postgis_topology
    - hstore
    - "uuid-ossp"
  become: yes
  become_user: postgres

- name: Configure RapidPro settings
  template:
    src: settings.py.j2
    dest: "{{ rapidpro_dir }}/temba/settings.py"
  become: yes

- name: Run database migrations
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry run python manage.py migrate
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"




- name: Collect static files
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry run python manage.py collectstatic --noinput
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"



- name: Get poetry environment path
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry env info --path
  args:
    chdir: "{{ rapidpro_dir }}"
  register: poetry_env
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Copy create_superuser.py script
  copy:
    src: create_superuser.py
    dest: "{{ rapidpro_dir }}/create_superuser.py"
    owner: "{{ iiab_admin_user }}"
    group: "{{ iiab_admin_user }}"
    mode: "0755"
  become: yes

- name: Create admin user
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    export DJANGO_SUPERUSER_EMAIL="{{ admin_email | default('admin@example.com') }}"
    export DJANGO_SUPERUSER_PASSWORD="{{ admin_password | default('changeme') }}"
    poetry run python manage.py shell < create_superuser.py
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"
  environment:
    DJANGO_SETTINGS_MODULE: temba.settings
  changed_when: "'Superuser created successfully!' in create_superuser_output.stdout"
  register: create_superuser_output

- name: Create gunicorn run directory
  file:
    path: "{{ rapidpro_dir }}/run"
    state: directory
    owner: "{{ iiab_admin_user }}"
    group: "www-data"
    mode: "0770"
  become: yes

- name: Create Gunicorn systemd service
  template:
    src: rapidpro-gunicorn.service.j2
    dest: /etc/systemd/system/rapidpro-gunicorn.service
  vars:
    poetry_env_path: "{{ poetry_env.stdout }}"
  become: yes

- name: Create spool directories
  file:
    path: "{{ rapidpro_dir }}/spool/{{ item }}"
    state: directory
    owner: "{{ iiab_admin_user }}"
    group: "{{ iiab_admin_user }}"
  loop:
    - mailroom/dynamo
    - courier/dynamo
  become: yes

- name: Check for valkey-server service
  stat:
    path: /lib/systemd/system/valkey-server.service
  register: valkey_service

- name: Set valkey service name
  set_fact:
    valkey_service_name: "{{ 'valkey-server.service' if valkey_service.stat.exists else 'redis-server.service' }}"

- name: Create Mailroom systemd service
  template:
    src: rapidpro-mailroom.service.j2
    dest: /etc/systemd/system/rapidpro-mailroom.service
  become: yes

- name: Create Courier systemd service
  template:
    src: rapidpro-courier.service.j2
    dest: /etc/systemd/system/rapidpro-courier.service
  become: yes




