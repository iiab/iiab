- name: Create PostgreSQL user
  postgresql_user:
    name: "{{ rapidpro_db_user }}"
    password: "{{ rapidpro_db_pass }}"
    login_host: 127.0.0.1
  become: yes
  become_user: postgres

- name: Create PostgreSQL database
  postgresql_db:
    name: "{{ rapidpro_db_name }}"
    owner: "{{ rapidpro_db_user }}"
    login_host: 127.0.0.1
  become: yes
  become_user: postgres

- name: Enable PostgreSQL extensions
  # The 'db' parameter is used for compatibility with older versions of the community.postgresql collection.
  # It should be changed to 'database' when the collection is updated to a version that supports it.
  postgresql_ext:
    name: "{{ item }}"
    db: "{{ rapidpro_db_name }}"
    login_db: postgres
    login_host: 127.0.0.1
  loop:
    - postgis
    - postgis_topology
    - hstore
    - "uuid-ossp"
  become: yes
  become_user: postgres

- name: Configure RapidPro common settings
  template:
    src: settings_common.py.j2
    dest: "{{ rapidpro_dir }}/temba/settings_common.py"
  become: yes
  register: rapidpro_settings_common

- name: Configure RapidPro settings
  template:
    src: settings.py.j2
    dest: "{{ rapidpro_dir }}/temba/settings.py"
  become: yes
  register: rapidpro_settings



- name: Run database migrations
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry run python manage.py migrate
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"
  when: rapidpro_git_clone.changed or rapidpro_settings_common.changed or rapidpro_settings.changed

- name: Create DynamoDB systemd service
  template:
    src: rapidpro-dynamo.service.j2
    dest: /etc/systemd/system/rapidpro-dynamo.service
  become: yes

- name: Force start rapidpro-dynamo for migrations
  systemd:
    name: rapidpro-dynamo
    state: started
    enabled: yes
    daemon_reload: yes
  become: yes
  when: ansible_service_mgr == 'systemd'

- name: Force start rapidpro-dynamo for migrations (Android)
  shell: /usr/local/bin/pdsm start rapidpro-dynamo
  become: yes
  when: ansible_service_mgr != 'systemd'

- name: Wait for DynamoDB to accept connections
  wait_for:
    port: 4567
    host: 127.0.0.1
    delay: 2
    timeout: 60
  when: rapidpro_git_clone.changed or rapidpro_settings_common.changed or rapidpro_settings.changed

- name: Run DynamoDB migrations
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry run python manage.py migrate_dynamo
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"
  run_once: yes
  when: rapidpro_git_clone.changed or rapidpro_settings_common.changed or rapidpro_settings.changed

- name: Collect static files
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry run python manage.py collectstatic --noinput
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"
  when: rapidpro_git_clone.changed or rapidpro_settings_common.changed or rapidpro_settings.changed

- name: Fix missing editor.json localization (Wuzapi Regression Fix)
  shell: |
    mkdir -p /opt/iiab/rapidpro/sitestatic/@nyaruka/temba-components/static/mr/docs/fr
    ln -sf ../en-us/editor.json /opt/iiab/rapidpro/sitestatic/@nyaruka/temba-components/static/mr/docs/fr/editor.json
  become: yes

- name: Create frontend patch script
  template:
    src: patch_frontend_urls.py.j2
    dest: "{{ rapidpro_dir }}/patch_urls.py"
    owner: "{{ iiab_admin_user }}"
    mode: '0755'
  become_user: "{{ iiab_admin_user }}"
  become: yes
  when: rapidpro_git_clone.changed or rapidpro_settings_common.changed or rapidpro_settings.changed

- name: Execute frontend patch script
  command: python3 {{ rapidpro_dir }}/patch_urls.py
  become_user: "{{ iiab_admin_user }}"
  become: yes
  register: execute_frontend_patch_script
  when: rapidpro_git_clone.changed or rapidpro_settings_common.changed or rapidpro_settings.changed

- name: Symlink mr directory for temba-store
  file:
    src: "{{ rapidpro_dir }}/sitestatic/@nyaruka/temba-components/static/mr"
    dest: "{{ rapidpro_dir }}/sitestatic/mr"
    state: link
  become_user: "{{ iiab_admin_user }}"
  become: yes



- name: Create custom url_tags.py
  template:
    src: url_tags.py.j2
    dest: "{{ rapidpro_dir }}/temba/utils/templatetags/url_tags.py"

- name: Get poetry environment path
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry env info --path
  args:
    chdir: "{{ rapidpro_dir }}"
  register: poetry_env
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Copy superuser scripts
  copy:
    src: "{{ item }}"
    dest: "{{ rapidpro_dir }}/{{ item }}"
    owner: "{{ iiab_admin_user }}"
    group: "{{ iiab_admin_user }}"
    mode: "0755"
  become: yes
  loop:
    - create_superuser.py
    - check_superuser.py

- name: Check if admin user exists
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    export DJANGO_SUPERUSER_EMAIL="{{ admin_email | default('admin@example.com') }}"
    poetry run python manage.py shell < check_superuser.py
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"
  environment:
    DJANGO_SETTINGS_MODULE: temba.settings
  register: superuser_check
  changed_when: false

- name: Create admin user
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    export DJANGO_SUPERUSER_EMAIL="{{ admin_email | default('admin@example.com') }}"
    export DJANGO_SUPERUSER_PASSWORD="{{ rapidpro_admin_password | default('changeme') }}"
    poetry run python manage.py shell < create_superuser.py
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"
  environment:
    DJANGO_SETTINGS_MODULE: temba.settings
  when: "'EXISTS' not in superuser_check.stdout"
  changed_when: "'Superuser created successfully!' in create_superuser_output.stdout"
  register: create_superuser_output

- name: Create gunicorn run directory
  file:
    path: "{{ rapidpro_dir }}/run"
    state: directory
    owner: "{{ iiab_admin_user }}"
    group: "www-data"
    mode: "0770"
  become: yes

- name: Check for valkey-server service
  stat:
    path: /lib/systemd/system/valkey-server.service
  register: valkey_service

- name: Set valkey service name
  set_fact:
    valkey_service_name: "{{ 'valkey-server.service' if valkey_service.stat.exists else 'redis-server.service' }}"

- name: Create Gunicorn systemd service
  template:
    src: rapidpro-gunicorn.service.j2
    dest: /etc/systemd/system/rapidpro-gunicorn.service
  vars:
    poetry_env_path: "{{ poetry_env.stdout }}"
  become: yes



- name: Create Mailroom systemd service
  template:
    src: rapidpro-mailroom.service.j2
    dest: /etc/systemd/system/rapidpro-mailroom.service
  become: yes

- name: Create Courier systemd service
  template:
    src: rapidpro-courier.service.j2
    dest: /etc/systemd/system/rapidpro-courier.service
  become: yes



- name: Create Celery systemd service
  template:
    src: rapidpro-celery.service.j2
    dest: /etc/systemd/system/rapidpro-celery.service
  vars:
    poetry_env_path: "{{ poetry_env.stdout }}"
  become: yes

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes
  when: ansible_service_mgr == 'systemd'

- name: Restart RapidPro Gunicorn if code changed
  systemd:
    name: rapidpro-gunicorn
    state: restarted
  become: yes
  when: execute_frontend_patch_script.changed and ansible_service_mgr == 'systemd'

- name: Restart RapidPro Gunicorn if code changed (Android)
  shell: /usr/local/bin/pdsm restart rapidpro-server
  become: yes
  when: execute_frontend_patch_script.changed and ansible_service_mgr != 'systemd'

- name: Enable or disable RapidPro services
  include_tasks: enable-or-disable.yml
