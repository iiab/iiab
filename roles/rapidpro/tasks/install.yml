---
# This file will contain all the installation tasks for RapidPro.

- name: Include Wuzapi role
  include_role:
    name: wuzapi
  when: wuzapi_install | default(true)

- name: Drop RapidPro database if requested
  block:
    - name: Stop RapidPro services before DB drop
      service:
        name: "{{ item }}"
        state: stopped
      with_items:
        - rapidpro-gunicorn
        - rapidpro-courier
        - rapidpro-mailroom
        - rapidpro-dynamo
        - rapidpro-celery
      ignore_errors: yes
      become: yes

    - name: Terminate all connections to the 'temba' database
      postgresql_query:
        query: "SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = '{{ rapidpro_db_name }}' AND pid <> pg_backend_pid();"
      become: yes
      become_user: postgres

    - name: Drop RapidPro PostgreSQL database
      postgresql_db:
        name: "{{ rapidpro_db_name }}"
        state: absent
      become: yes
      become_user: postgres

    - name: Drop RapidPro PostgreSQL user
      postgresql_user:
        name: "{{ rapidpro_db_user }}"
        state: absent
      become: yes
      become_user: postgres
  when: rapidpro_force_drop_db | default(false)

- name: Uninstall RapidPro if reinstalling
  block:
    - name: Get poetry environment path
      shell: |
        export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
        poetry env info --path
      args:
        chdir: "{{ rapidpro_dir }}"
      register: poetry_env
      become: yes
      become_user: "{{ iiab_admin_user }}"
      changed_when: false
      failed_when: false

    - name: Remove poetry virtualenv
      file:
        path: "{{ poetry_env.stdout }}"
        state: absent
      become: yes
      become_user: root
      when: poetry_env.stdout != ""

    - name: Remove RapidPro directory
      file:
        path: "{{ rapidpro_dir }}"
        state: absent
      become: yes
  when: reinstall is defined and reinstall

- name: Install essential build tools and libraries
  apt:
    name:
      - git
      - build-essential
      - libpq-dev
      - python3-dev
      - libgdal-dev
      - ffmpeg
      - postgis
    state: present
  become: yes

- name: Install Valkey/Redis
  block:
    - name: Try installing valkey-server
      apt:
        name: valkey-server
        state: present
      become: yes
  rescue:
    - name: Fallback to redis-server
      apt:
        name: redis-server
        state: present
      become: yes

- name: Install Python build dependencies
  apt:
    name:
      - make
      - libssl-dev
      - zlib1g-dev
      - libffi-dev
      - wget
      - curl
      - python3-openssl
    state: present
  become: yes

- name: "Set 'nodejs_install: True' and 'nodejs_enabled: True'"
  set_fact:
    nodejs_install: True
    nodejs_enabled: True

- name: Include nodejs role
  include_role:
    name: nodejs

- name: Add rapidpro directory to git safe directories
  command: git config --global --add safe.directory {{ rapidpro_dir }}
  become: yes
  changed_when: false

- name: Clone/update RapidPro repository
  git:
    repo: 'https://github.com/deldesir/rapidpro.git'
    dest: "{{ rapidpro_dir }}"
    force: yes
    version: main
  become: yes
  register: rapidpro_git_clone

- name: Set ownership of project directory (fast)
  command: "chown -R {{ iiab_admin_user }}:www-data {{ rapidpro_dir }}"
  become: yes
  changed_when: false

- name: "Allow Python version in pyproject.toml"
  replace:
    path: "{{ rapidpro_dir }}/pyproject.toml"
    regexp: 'requires-python = ">=3.12,<3.13"'
    replace: 'requires-python = ">=3.12,<3.{{ (ansible_python_version.split(''.'')[1] | int) + 1 }}"'
  become: yes

- name: Install Poetry
  shell: |
    curl -sSL https://install.python-poetry.org | python3 -
  args:
    creates: "/home/{{ iiab_admin_user }}/.local/bin/poetry"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Fix permissions on Poetry cache (fast)
  shell: |
    if [ -d "/home/{{ iiab_admin_user }}/.cache/pypoetry" ]; then
      chown -R {{ iiab_admin_user }}:{{ iiab_admin_user }} /home/{{ iiab_admin_user }}/.cache/pypoetry
    fi
  become: yes
  changed_when: false

- name: Add missing regex dependency
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry add regex
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Add missing dependencies
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry add gunicorn celery
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"

# Patches removed as they are integrated into deldesir/rapidpro fork





- name: Install Python dependencies with Poetry
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry env remove --all
    poetry env use $(which python3)
    poetry lock
    poetry install --without dev
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Install yarn
  npm:
    name: yarn
    global: yes
  become: yes

- name: Install dynalite
  npm:
    name: dynalite
    global: yes
  become: yes

- name: Install JavaScript dependencies (with timeout)
  shell: |
    /usr/bin/yarn install --network-timeout 300000 --non-interactive
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  register: rapidpro_yarn_install
  changed_when: false

- name: Install global JS tools (less)
  yarn:
    name: less
    global: yes
  become: yes

- name: Build CSS assets
  shell: |
    yarn tw-build
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  when: rapidpro_git_clone.changed or rapidpro_yarn_install.changed

- name: Restore RapidPro Directory Ownership (after root build steps)
  command: "chown -R {{ iiab_admin_user }}:{{ iiab_admin_user }} {{ rapidpro_dir }}"
  become: yes
  when: rapidpro_git_clone.changed or rapidpro_yarn_install.changed

- name: Allow Nginx traversal of RapidPro directory (Professional Fix)
  file:
    path: "{{ rapidpro_dir }}"
    mode: '0751'
    state: directory
  become: yes

- name: "Set mailroom and courier architecture"
  set_fact:
    rapidpro_go_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"



- name: Install Mailroom Binary from Release
  get_url:
    url: "https://github.com/deldesir/mailroom/releases/download/v26.1.0/mailroom-linux-{{ rapidpro_go_arch }}"
    dest: /usr/local/bin/mailroom
    mode: '0755'
    force: yes
  become: yes

- name: Install Courier Binary from Release
  get_url:
    url: "https://github.com/deldesir/courier/releases/download/v26.0.1/courier-linux-{{ rapidpro_go_arch }}"
    dest: /usr/local/bin/courier
    mode: '0755'
    force: yes
  become: yes



- name: Enable and Start PDSM services (Android/Proot only)
  shell: |
    /usr/local/bin/pdsm enable {{ item }}
    /usr/local/bin/pdsm start {{ item }}
  loop:
    - postgresql
    - valkey
    - rapidpro-dynamo
  become: yes
  when: ansible_service_mgr != 'systemd'
