---
# This file will contain all the installation tasks for RapidPro.

- name: Uninstall RapidPro if reinstalling
  block:
    - name: Get poetry environment path
      shell: |
        export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
        poetry env info --path
      args:
        chdir: "{{ rapidpro_dir }}"
      register: poetry_env
      become: yes
      become_user: "{{ iiab_admin_user }}"
      changed_when: false
      failed_when: false

    - name: Remove poetry virtualenv
      file:
        path: "{{ poetry_env.stdout }}"
        state: absent
      become: yes
      become_user: "{{ iiab_admin_user }}"
      when: poetry_env.stdout != ""

    - name: Remove RapidPro directory
      file:
        path: "{{ rapidpro_dir }}"
        state: absent
      become: yes
  when: reinstall is defined and reinstall



- name: Include nginx role
  include_role:
    name: nginx

- name: "Set 'postgresql_install: True' and 'postgresql_enabled: True'"
  set_fact:
    postgresql_install: True
    postgresql_enabled: True

- name: Include postgresql role
  include_role:
    name: postgresql

- name: Install essential build tools and libraries
  apt:
    name:
      - git
      - build-essential
      - libpq-dev
      - python3-dev
      - libgdal-dev
      - ffmpeg
    state: present
  become: yes



- name: Install Valkey/Redis
  block:
    - name: Try installing valkey-server
      apt:
        name: valkey-server
        state: present
      become: yes
  rescue:
    - name: Fallback to redis-server
      apt:
        name: redis-server
        state: present
      become: yes

- name: Install Python build dependencies
  apt:
    name:
      - make
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - wget
      - curl
      - llvm
      - libncurses5-dev
      - libncursesw5-dev
      - xz-utils
      - tk-dev
      - libffi-dev
      - liblzma-dev
      - python3-openssl
    state: present
  become: yes

- name: "Set 'nodejs_install: True' and 'nodejs_enabled: True'"
  set_fact:
    nodejs_install: True
    nodejs_enabled: True

- name: Include nodejs role
  include_role:
    name: nodejs

- name: Check if rapidpro directory exists
  stat:
    path: "{{ rapidpro_dir }}"
  register: rapidpro_dir_stat

- name: Clone RapidPro repository
  git:
    repo: 'https://github.com/nyaruka/rapidpro.git'
    dest: "{{ rapidpro_dir }}"
  become: yes
  when: not rapidpro_dir_stat.stat.exists

- name: Allow Python 3.13 in pyproject.toml
  replace:
    path: "{{ rapidpro_dir }}/pyproject.toml"
    regexp: 'requires-python = ">=3.12,<3.13"'
    replace: 'requires-python = ">=3.12,<3.14"'
  become: yes

- name: Set ownership of project directory
  file:
    path: "{{ rapidpro_dir }}"
    state: directory
    owner: "{{ iiab_admin_user }}"
    group: "www-data"
    mode: "0770"
    recurse: yes
  become: yes

- name: Check if patch can be applied
  command: git apply --check {{ role_path }}/files/0001-Fix-hardcoded-URLs.patch
  args:
    chdir: "{{ rapidpro_dir }}"
  register: patch_check
  changed_when: false
  failed_when: false
  become: yes

- name: Apply patch for subpath deployment
  command: git apply {{ role_path }}/files/0001-Fix-hardcoded-URLs.patch
  args:
    chdir: "{{ rapidpro_dir }}"
  when: patch_check.rc == 0
  become: yes


- name: Install Poetry
  shell: |
    curl -sSL https://install.python-poetry.org | python3 -
  args:
    creates: "/home/{{ iiab_admin_user }}/.local/bin/poetry"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Install Python dependencies with Poetry
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry lock
    poetry install
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Install yarn
  npm:
    name: yarn
    global: yes
  become: yes

- name: Install JavaScript dependencies
  yarn:
    path: "{{ rapidpro_dir }}"
  become: yes

- name: Install global JS tools (less)
  yarn:
    name: less
    global: yes
  become: yes

- name: Build CSS assets
  shell: |
    yarn tw-build
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes

- name: Set mailroom and courier architecture
  set_fact:
    rapidpro_go_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"

- name: Download Mailroom
  get_url:
    url: "https://github.com/nyaruka/mailroom/releases/download/v10.2.0/mailroom_10.2.0_linux_{{ rapidpro_go_arch }}.tar.gz"
    dest: /tmp/mailroom.tar.gz
  become: yes

- name: Install Mailroom
  unarchive:
    src: /tmp/mailroom.tar.gz
    dest: "/usr/local/bin/"
    remote_src: no
    extra_opts: [--strip-components=1]
  become: yes

- name: Download Courier
  get_url:
    url: "https://github.com/nyaruka/courier/releases/download/v10.2.0/courier_10.2.0_linux_{{ rapidpro_go_arch }}.tar.gz"
    dest: /tmp/courier.tar.gz
  become: yes

- name: Install Courier
  unarchive:
    src: /tmp/courier.tar.gz
    dest: "/usr/local/bin/"
    remote_src: no
    extra_opts: [--strip-components=1]
  become: yes
