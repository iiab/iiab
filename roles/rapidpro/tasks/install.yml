---
# This file will contain all the installation tasks for RapidPro.

- name: Include Wuzapi role
  include_role:
    name: wuzapi
  when: wuzapi_install | default(true)

- name: Drop RapidPro database if requested
  block:
    - name: Stop RapidPro services before DB drop
      service:
        name: "{{ item }}"
        state: stopped
      with_items:
        - rapidpro-gunicorn
        - rapidpro-courier
        - rapidpro-mailroom
        - rapidpro-dynamo
        - rapidpro-celery
      ignore_errors: yes
      become: yes

    - name: Terminate all connections to the 'temba' database
      postgresql_query:
        query: "SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = '{{ rapidpro_db_name }}' AND pid <> pg_backend_pid();"
      become: yes
      become_user: postgres

    - name: Drop RapidPro PostgreSQL database
      postgresql_db:
        name: "{{ rapidpro_db_name }}"
        state: absent
      become: yes
      become_user: postgres

    - name: Drop RapidPro PostgreSQL user
      postgresql_user:
        name: "{{ rapidpro_db_user }}"
        state: absent
      become: yes
      become_user: postgres
  when: rapidpro_force_drop_db | default(false)

- name: Uninstall RapidPro if reinstalling
  block:
    - name: Get poetry environment path
      shell: |
        export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
        poetry env info --path
      args:
        chdir: "{{ rapidpro_dir }}"
      register: poetry_env
      become: yes
      become_user: "{{ iiab_admin_user }}"
      changed_when: false
      failed_when: false

    - name: Remove poetry virtualenv
      file:
        path: "{{ poetry_env.stdout }}"
        state: absent
      become: yes
      become_user: root
      when: poetry_env.stdout != ""

    - name: Remove RapidPro directory
      file:
        path: "{{ rapidpro_dir }}"
        state: absent
      become: yes
  when: reinstall is defined and reinstall

- name: Install essential build tools and libraries
  apt:
    name:
      - git
      - build-essential
      - libpq-dev
      - python3-dev
      - libgdal-dev
      - ffmpeg
      - postgis
      - golang-go
    state: present
  become: yes

- name: Install Valkey/Redis
  block:
    - name: Try installing valkey-server
      apt:
        name: valkey-server
        state: present
      become: yes
  rescue:
    - name: Fallback to redis-server
      apt:
        name: redis-server
        state: present
      become: yes

- name: Install Python build dependencies
  apt:
    name:
      - make
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - wget
      - curl
      - llvm
      - libncurses5-dev
      - libncursesw5-dev
      - xz-utils
      - tk-dev
      - libffi-dev
      - liblzma-dev
      - python3-openssl
    state: present
  become: yes

- name: "Set 'nodejs_install: True' and 'nodejs_enabled: True'"
  set_fact:
    nodejs_install: True
    nodejs_enabled: True

- name: Include nodejs role
  include_role:
    name: nodejs

- name: Add rapidpro directory to git safe directories
  command: git config --global --add safe.directory {{ rapidpro_dir }}
  become: yes
  changed_when: false

- name: Clone/update RapidPro repository
  git:
    repo: 'https://github.com/deldesir/rapidpro.git'
    dest: "{{ rapidpro_dir }}"
    force: yes
    version: main
  become: yes
  register: rapidpro_git_clone

- name: Set ownership of project directory
  file:
    path: "{{ rapidpro_dir }}"
    state: directory
    owner: "{{ iiab_admin_user }}"
    group: "www-data"
    mode: "0770"
    recurse: yes
  become: yes

- name: "Allow Python version in pyproject.toml"
  replace:
    path: "{{ rapidpro_dir }}/pyproject.toml"
    regexp: 'requires-python = ">=3.12,<3.13"'
    replace: 'requires-python = ">=3.12,<3.{{ (ansible_python_version.split(''.'')[1] | int) + 1 }}"'
  become: yes

# Patches removed as they are integrated into deldesir/rapidpro fork



- name: Install Poetry
  shell: |
    curl -sSL https://install.python-poetry.org | python3 -
  args:
    creates: "/home/{{ iiab_admin_user }}/.local/bin/poetry"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Fix permissions on Poetry cache
  file:
    path: "/home/{{ iiab_admin_user }}/.cache/pypoetry"
    owner: "{{ iiab_admin_user }}"
    group: "{{ iiab_admin_user }}"
    recurse: yes
  become: yes

- name: Install Python dependencies with Poetry
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry env remove --all
    poetry env use $(which python3)
    poetry lock
    poetry install
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Install yarn
  npm:
    name: yarn
    global: yes
  become: yes

- name: Install dynalite
  npm:
    name: dynalite
    global: yes
  become: yes

- name: Install JavaScript dependencies
  yarn:
    path: "{{ rapidpro_dir }}"
  become: yes
  register: rapidpro_yarn_install

- name: Install global JS tools (less)
  yarn:
    name: less
    global: yes
  become: yes

- name: Build CSS assets
  shell: |
    yarn tw-build
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  when: rapidpro_git_clone.changed or rapidpro_patch_result.changed or rapidpro_yarn_install.changed

- name: Restore RapidPro Directory Ownership (after root build steps)
  file:
    path: "{{ rapidpro_dir }}"
    owner: "{{ iiab_admin_user }}"
    group: "{{ iiab_admin_user }}"
    recurse: yes
  become: yes
  when: rapidpro_git_clone.changed or rapidpro_patch_result.changed or rapidpro_yarn_install.changed

- name: Allow Nginx traversal of RapidPro directory (Professional Fix)
  file:
    path: "{{ rapidpro_dir }}"
    mode: '0751'
    state: directory
  become: yes

- name: "Set mailroom and courier architecture"
  set_fact:
    rapidpro_go_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"

- name: Cleanup Go Builds (Pre-flight)
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /tmp/mailroom
    - /tmp/courier
  become: yes

- name: Create Disk-based Go Build Directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0777'
  with_items:
    - /var/tmp/rapidpro_go_build/gocache
    - /var/tmp/rapidpro_go_build/gopath
    - /var/tmp/rapidpro_go_build/tmp
  become: yes

- name: Install Mailroom Binary from Release
  get_url:
    url: "https://github.com/deldesir/mailroom/releases/download/v1.0.0/mailroom-linux-{{ rapidpro_go_arch }}"
    dest: /usr/local/bin/mailroom
    mode: '0755'
    force: yes
  become: yes

- name: Install Courier Binary from Release
  get_url:
    url: "https://github.com/deldesir/courier/releases/download/v10.4.0/courier-linux-{{ rapidpro_go_arch }}"
    dest: /usr/local/bin/courier
    mode: '0755'
    force: yes
  become: yes

- name: Cleanup Go Builds
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /tmp/mailroom
    - /tmp/courier
  become: yes

- name: Cleanup Go Build Cache (Disk)
  file:
    path: /var/tmp/rapidpro_go_build
    state: absent
  become: yes
