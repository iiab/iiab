From 0882b4f9b679b05f8edbec49802de4e30f1f3a50 Mon Sep 17 00:00:00 2001
From: Blondel MONDESIR <blondel.md@gmail.com>
Date: Fri, 7 Nov 2025 09:27:44 +0100
Subject: [PATCH] Fix hardcoded URLs to support subpath deployment

---
 temba/orgs/views/views.py               | 2 +-
 templates/allauth/layouts/entrance.html | 8 ++++----
 templates/orgs/org_join.html            | 2 +-
 templates/public/public_frame.html      | 2 +-
 templates/public/public_index.html      | 2 +-
 5 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/temba/orgs/views/views.py b/temba/orgs/views/views.py
index 08a371204..74972bb93 100644
--- a/temba/orgs/views/views.py
+++ b/temba/orgs/views/views.py
@@ -604,7 +604,7 @@ class OrgCRUDL(SmartCRUDL):
                                 menu_id="logout",
                                 name=_("Sign Out"),
                                 icon="logout",
-                                href="/accounts/logout/",
+                                href=reverse("account_logout"),
                                 posterize=True,
                             ),
                             self.create_space(),
diff --git a/templates/allauth/layouts/entrance.html b/templates/allauth/layouts/entrance.html
index faf642dc0..aaf8fcf65 100644
--- a/templates/allauth/layouts/entrance.html
+++ b/templates/allauth/layouts/entrance.html
@@ -1,4 +1,4 @@
-{% extends "allauth/layouts/entrance.html" %}
+{% extends "allauth/layouts/base.html" %}
 {% block extra-style %}
   {{ block.super }}
   <style>
@@ -33,13 +33,13 @@
       margin-bottom: 0;
     }
 
-    form[action="/accounts/login/"] button[type="submit"],
-    form[action="/accounts/2fa/authenticate/"] button[type="submit"] {
+    form[action*="/accounts/login/"] button[type="submit"],
+    form[action*="/accounts/2fa/authenticate/"] button[type="submit"] {
       display: block;
       width: 100%;
     }
 
-    form[action="/accounts/2fa/authenticate/"] button[form="logout-from-stage"] {
+    form[action*="/accounts/2fa/authenticate/"] button[form="logout-from-stage"] {
       display: none;
     }
   </style>
diff --git a/templates/orgs/org_join.html b/templates/orgs/org_join.html
index 3b1882e50..28e435da1 100644
--- a/templates/orgs/org_join.html
+++ b/templates/orgs/org_join.html
@@ -16,7 +16,7 @@
     {% endblocktrans %}
   </div>
   <form method="post"
-        action="/accounts/login/?next={% url 'orgs.org_join_accept' invitation.secret %}"
+        action="{% url 'account_login' %}?next={% url 'orgs.org_join_accept' invitation.secret %}"
         class="mt-6"
         id="login-form">
     <fieldset>
diff --git a/templates/public/public_frame.html b/templates/public/public_frame.html
index aaa748c72..f86951bcb 100644
--- a/templates/public/public_frame.html
+++ b/templates/public/public_frame.html
@@ -6,7 +6,7 @@
       <div class="flex-grow"></div>
       <div class="w-128">
         <div class="mb-6 w-64 mt-12">
-          <a href="/">
+          <a href="{% url 'public.public_index' %}">
             <img src="{{ STATIC_URL }}images/logo-dark.svg">
           </a>
         </div>
diff --git a/templates/public/public_index.html b/templates/public/public_index.html
index a5df1551b..7760338fd 100644
--- a/templates/public/public_index.html
+++ b/templates/public/public_index.html
@@ -4,7 +4,7 @@
   <div class="text-xl font-normal mb-2 mt-6">Getting Started</div>
   <div class="mb-2">
     To get started, visit the  <a href="http://rapidpro.github.io/rapidpro/docs/development/">developer documentation</a>.
-    Once you've created an account in your development database, you can login <a href="/accounts/login">here</a>.
+    Once you've created an account in your development database, you can login <a href="{% url 'account_login' %}">here</a>.
   </div>
   <div class="mb-2">
     If you still have questions, please search the history on the <a href="https://groups.google.com/g/rapidpro-dev">developer list</a> to see if your question has been asked before.
-- 
2.43.0

