# This is for an OS other than Fedora 18

- name: Install missing packages required for kalite startup
  package: name={{ item }}
           state=present
  with_items:
    - lsb
  tags:
    - download
  when: internet_available  and ansible_distribution == "CentOS"

# Version 0.17.x
# pip show kalite
# Requires: docopt, South, django-js-reverse, ply, slimit, six, django-appconf,
# peewee, python-dateutil, django-dbbackup

# from /usr/lib/python2.7/site-packages/ka_lite-0.16.0-py2.7.egg-info/requires.txt
# docopt>=0.6,<0.7
# South==0.8.4
# django-js-reverse==0.5.0 ## no rpm
# ply==3.4
# slimit==0.8.1
# six==1.9.0
# django-appconf==1.0.1
# peewee==2.6.3
# python-dateutil==2.4.2
# django-dbbackup==2.3.2   ## no rpm

- name: use pip to uninstall setuptools for centos
  command: pip uninstall --yes setuptools
  when: ansible_distribution == "CentOS"

- name: Get an unbroken version of setuptools for centos
  command: pip install setuptools==28.8.0
  when: ansible_distribution == "CentOS"

 

- name: Downoad kalite with pip
  pip: name=ka-lite version={{ kalite_version }}
       extra_args="--download {{ pip_packages_dir }}"
  when: internet_available 
  tags:
    - download2

- name: Install kalite with pip
  pip: name=ka-lite version={{ kalite_version }}
       extra_args="--no-index --find-links=file://{{ pip_packages_dir }}"

- name: Default is to have cronserve started with kalite
  set_fact:
     job_scheduler_stanza: ""

- name: Add  --skip-job-scheduler to start if cronserve not enabled
  set_fact:
     job_scheduler_stanza: "--skip-job-scheduler "
  when: not kalite_cron_enabled

- name: Create kalite service(s) and support scripts
  template: backup=yes
            src={{ item.src }}
            dest={{ item.dest }}
            owner=root
            group=root
            mode={{ item.mode }}
  with_items:
    - { src: 'kalite-serve.service.j2', dest: '/etc/systemd/system/kalite-serve.service', mode: '0644'}
    - { src: 'kalite.sh.j2', dest: '/etc/profile.d/kalite.sh', mode: '0644'}
