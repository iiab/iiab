- name: Record (initial) disk space used
  shell: df -B1 --output=used / | tail -1
  register: df1

# https://github.com/foundObjects/zram-swap/issues/8
- name: Install linux-modules-extra if Ubuntu
  package:
    name: linux-modules-extra
    state: present
  when: is_ubuntu and ansible_architecture == "x86_64"

- name: Install linux-modules-extra-raspi if Ubuntu on Raspberry Pi
  package:
    name: linux-modules-extra-raspi
    state: present
  when: is_ubuntu and ansible_architecture != "x86_64"


- name: Git clone https://github.com/foundObjects/zram-swap.git to /opt/iiab/zram
  git:
    repo: https://github.com/foundObjects/zram-swap
    dest: /opt/iiab/zram
    version: v02
    depth: 1
    force: yes

- name: Install zram-swap
  shell: |
    cd /opt/iiab/zram
    ./install.sh



# RECORD zram AS INSTALLED

- name: Record (final) disk space used
  shell: df -B1 --output=used / | tail -1
  register: df2

- name: Add 'zram_disk_usage = {{ df2.stdout | int - df1.stdout | int }}' to {{ iiab_ini_file }}
  ini_file:
    path: "{{ iiab_ini_file }}"    # /etc/iiab/iiab.ini
    section: zram
    option: zram_disk_usage
    value: "{{ df2.stdout | int - df1.stdout | int }}"

- name: "Set 'zram_installed: True'"
  set_fact:
    zram_installed: True

- name: "Add 'zram_installed: True' to {{ iiab_state_file }}"
  lineinfile:
    path: "{{ iiab_state_file }}"    # /etc/iiab/iiab_state.yml
    regexp: '^zram_installed'
    line: 'zram_installed: True'
