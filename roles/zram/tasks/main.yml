- name: Record (initial) disk space used
  shell: df -B1 --output=used / | tail -1
  register: df1


- name: Install systemd-zram-generator
  package:
    name: systemd-zram-generator
    state: present

- name: Trigger /lib/systemd/system-generators/zram-generator
  command: systemctl daemon-reexec
  become: true
  changed_when: false

- name: Enable and start systemd-zram-generator
  systemd:
    name: systemd-zram-setup@zram0.service
    enabled: true
    state: started


- name: Configure zram sysctl parameters
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
  with_items:
    # https://docs.kernel.org/admin-guide/sysctl/vm.html#swappiness
    - { key: "vm.swappiness", value: "120" }
    #- { key: "vm.watermark_boost_factor", value: "0" }
    #- { key: "vm.watermark_scale_factor", value: "125" }
    #- { key: "vm.defrag_mode", value: "1" }
    #- { key: "vm.extfrag_threshold", value: "350" }
    #- { key: "vm.page-cluster", value: "0" }


# RECORD zram AS INSTALLED

- name: Record (final) disk space used
  shell: df -B1 --output=used / | tail -1
  register: df2

- name: Add 'zram_disk_usage = {{ df2.stdout | int - df1.stdout | int }}' to {{ iiab_ini_file }}
  ini_file:
    path: "{{ iiab_ini_file }}"    # /etc/iiab/iiab.ini
    section: zram
    option: zram_disk_usage
    value: "{{ df2.stdout | int - df1.stdout | int }}"

- name: "Set 'zram_installed: True'"
  set_fact:
    zram_installed: True

- name: "Add 'zram_installed: True' to {{ iiab_state_file }}"
  lineinfile:
    path: "{{ iiab_state_file }}"    # /etc/iiab/iiab_state.yml
    regexp: '^zram_installed'
    line: 'zram_installed: True'
