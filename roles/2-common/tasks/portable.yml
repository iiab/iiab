- name: Test for {{ iiab_base }}/{{ library_img }}
  command: test -f {{ iiab_base }}/{{ library_img }}
  failed_when: False
  register: library_img_present

- name: Debug library_img_present
  debug:
    var: library_img_present

- block:
  - name: Create new container image to hold /library of {{ library_size }} in size
    command: dd if=/dev/zero of={{ iiab_base }}/{{ library_img }} bs=1 count=0 seek={{ library_size }}

  - name: Create ext4 filesystem inside new container
    command: mkfs.ext4 {{ iiab_base }}/{{ library_img }}

  - name: Create /library mountpoint
    file:
      path: /library
      state: directory
  when: not library_img_present.rc == 0
  #end block

- name: Unmount /library
  command: umount /library
  failed_when: False
  when: library_img_present.rc == 0

- name: Check ext4 filesystem inside container
  command: e2fsck -y -f {{ iiab_base }}/{{ library_img }}

- name: Clear old fstab entries for /library
  command: sed -i "/library/d" /etc/fstab

- name: Create new fstab entry
  lineinfile:
    path: /etc/fstab
    state: present
    line: '{{ iiab_base }}/{{ library_img }}	/library	ext4	loop	0 0'

- name: Mount {{ iiab_base }}/{{ library_img }} at /library
  command: mount -a
