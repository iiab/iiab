- name: Record (initial) disk space used
  shell: df -B1 --output=used / | tail -1
  register: df1


- name: Make code directories available
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ code_data_root }}"
    - "{{ code_serve_path }}"

- name: Copy static assets
  ansible.builtin.copy:
    src: static/
    dest: "{{ code_data_root_static }}"

- name: "Ensure code_apk_release_name is set (autodetect latest armv8a APK if empty)"
  when: code_apk_release_name | length == 0
  block:

    - name: "Fetch APK index page from {{ adfa_code_download_url }}/"
      ansible.builtin.uri:
        url: "{{ adfa_code_download_url }}/"
        return_content: true
      register: apk_index
      failed_when: >
        apk_index.status is defined
        and apk_index.status != 200
        and apk_index.status != 403

    - name: "Warn about APK index 403 blocking"
      fail:
        msg: |
          The 'code' role could not access: {{ adfa_code_download_url }}/ (HTTP {{ apk_index.status }}). CDN is likely blocking datacenter IPs; see pause banner below.
          ================ CODE ROLE WARNING ================
          The 'code' role hit a CDN 403 (APK index query blocked).

          HTTP status: {{ apk_index.status }}
          This likely means the APK store is behind some CDN and
          blocking datacenter IP ranges, so non-interactive curl/Ansible
          requests get a 403 "Just a moment..." page.

          GitHub issues/PRs related:
          - https://github.com/iiab/iiab/issues/4174
          - https://github.com/iiab/iiab/pull/4176

          Continuing IIAB without CodeOnTheGo APK content...
          ===================================================
      when: apk_index.status | default(0) == 403
      ignore_errors: yes

    - name: "Warn about APK index 403 blocking"
      ansible.builtin.pause:
        seconds: 20
      when: apk_index.status | default(0) == 403

    - name: "Mark 'code' role as blocked by CDN"
      ansible.builtin.set_fact:
        code_blocked_by_cdn: true
      when: apk_index.status | default(0) == 403

    - name: "Extract latest armv8a APK filename from index"
      ansible.builtin.set_fact:
        code_apk_release_name: >-
          {{
            apk_index.content
            | regex_findall(code_apk_pattern)
            | unique
            | sort
            | last
          }}
      when: not code_blocked_by_cdn

    - name: "Show resolved APK release name"
      ansible.builtin.debug:
        var: code_apk_release_name
      when: not code_blocked_by_cdn

- name: Get CodeOnTheGo version number
  ansible.builtin.set_fact:
    cotg_version: "{{ code_apk_release_name | regex_search('CodeOnTheGo-release([0-9.]+)', '\\1') }}"
  when: not code_blocked_by_cdn

- name: Make index.html file
  ansible.builtin.template:
    src: "index.html.j2"
    dest: "{{ code_serve_path }}/index.html"
    mode: "0644"

- name: Make content directory
  file:
    path: "{{ code_data_root_content }}"
    state: directory
    mode: "0755"

- name: Render localized Markdown content files
  ansible.builtin.template:
    src: "content/{{ item }}.md.j2"
    dest: "{{ code_data_root_content }}/{{ item }}.md"
    mode: "0644"
  loop:
    - en
    - es
  when: not code_blocked_by_cdn
  
- name: Continue APK install tasks when no 403 blocking
  ansible.builtin.include_tasks: install_apkfile.yml
  when: not code_blocked_by_cdn | default(false)


# RECORD CODE AS INSTALLED

- name: Record (final) disk space used
  shell: df -B1 --output=used / | tail -1
  register: df2

- name: Add 'code_disk_usage = {{ df2.stdout | int - df1.stdout | int }}' to {{ iiab_ini_file }}
  ini_file:
    path: "{{ iiab_ini_file }}"    # /etc/iiab/iiab.ini
    section: code
    option: code_disk_usage
    value: "{{ df2.stdout | int - df1.stdout | int }}"

- name: "Set 'code_installed: True'"
  set_fact:
    code_installed: True

- name: "Add 'code_installed: True' to {{ iiab_state_file }}"
  lineinfile:
    path: "{{ iiab_state_file }}"    # /etc/iiab/iiab_state.yml
    regexp: '^code_installed'
    line: 'code_installed: True'
