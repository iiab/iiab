- name: Create user {{ iiab_admin_user }} in group sudo for Admin Console; set password from iiab_admin_pwd_hash if newly creating account
  user:
    name: "{{ iiab_admin_user }}"    # iiab-admin
    password: "{{ iiab_admin_pwd_hash }}"
    update_password: on_create
    shell: /bin/bash
    groups: sudo

#- name: Create a wheel group
#  group:
#    name: wheel
#    state: present

#- name: Create a sudo group (redhat)
#  group:
#    name: sudo
#    state: present
#  when: is_redhat | bool

#- name: 'Add user {{ iiab_admin_user }} to groups: wheel, sudo'
#  user:
#    name: "{{ iiab_admin_user }}"
#    groups: wheel,sudo

- name: Edit the sudoers file -- first make it editable
  file:
    path: /etc/sudoers
    mode: 0640

- name: Have sudo log all commands it handles
  lineinfile:
    regexp: logfile
    line: "Defaults     logfile = /var/log/sudo.log"
    dest: /etc/sudoers
    state: present

#- name: Lets {{ iiab_admin_user }} sudo without password
##- name: Lets wheel sudo without password
#  lineinfile:
#    line: "{{ iiab_admin_user }} ALL=(ALL) NOPASSWD: ALL"
##    line: "%wheel ALL= NOPASSWD: ALL"
#    dest: /etc/sudoers

- name: Remove the line which requires tty
  lineinfile:
    regexp: requiretty
    dest: /etc/sudoers
    state: absent

- name: End editing the sudoers file -- protect it again
  file:
    path: /etc/sudoers
    mode: 0440

- name: Install /etc/profile.d/sshpwd-profile-iiab.sh from template, to issue warnings (during shell/ssh logins) if iiab-admin password is the default
  template:
    src: sshpwd-profile-iiab.sh
    dest: /etc/profile.d/
    mode: '0644'

- name: Is this LXDE-pi?
  stat:
    path: /etc/xdg/lxsession/LXDE-pi
  register: lx

- name: "Likewise for Raspbian, installing: /etc/xdg/lxsession/LXDE-pi/sshpwd-lxde-iiab.sh"
  template:
    src: sshpwd-lxde-iiab.sh
    dest: /etc/xdg/lxsession/LXDE-pi/
    mode: '0755'
  when: lx.stat.isdir is defined and lx.stat.isdir and is_raspbian and is_debuntu

# 2019-03-07: This popup (/etc/xdg/lxsession/LXDE-pi/sshpwd-lxde-iiab.sh) does
# not actually appear when triggered by /etc/xdg/autostart/pprompt-iiab.desktop
# (or pprompt.desktop as Raspbian has working since 2018-11-13!)  Too bad as it
# would be really nice to standardize this popup across Ubermix & all distros..
# Is this a permissions/security issue presumably?  Official autostart spec is:
# https://specifications.freedesktop.org/autostart-spec/autostart-spec-latest.html
# Raspbian's 2016-2018 evolution here: https://github.com/iiab/iiab/issues/1537

- name: Put line in /etc/xdg/lxsession/LXDE-pi/autostart to run the above (raspbian)
  lineinfile:
    path: /etc/xdg/lxsession/LXDE-pi/autostart
    line: "@/etc/xdg/lxsession/LXDE-pi/sshpwd-lxde-iiab.sh"
  when: lx.stat.isdir is defined and lx.stat.isdir and is_raspbian and is_debuntu
