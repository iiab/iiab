- block:
  - name: test that {{ library_loc }} && {{ library_img }} are defined
    debug:
      msg: "VARIABLE MUST BE DEFINED: '{{ library_loc }} && {{ library_img }}' NEEDS A PROPER VALUE e.g. IN: /etc/iiab/local_vars.yml"
  - meta: end_play
  when: not library_img is defined or not library_loc is defined

# doesn't need conditional just looks better skipping, when the mountpoint does not exsist yet on new installs
- name: Unmount /library -- don't panic if not found
  command: umount /library
  failed_when: False
  when: iiab_stage|int == 9

- block:
  - name: Retrieve {{ library_base_url }} to {{ library_loc }}/{{ library_img }}
    get_url:
      url: "{{ library_base_url }}"
      dest: "{{ library_loc }}/{{ library_img }}"
    when: library_base_url is defined

  - name: Retrieve {{ library_base_path }} to {{ library_loc }}/{{ library_img }}
    copy:
      src: "{{ library_base_path }}"
      dest: "{{ library_loc }}/{{ library_img }}"
    when: library_base_path is defined

  - name: Check ext4 filesystem inside container
    command: e2fsck -y -f {{ library_loc }}/{{ library_img }}

  - name: Expand {{ library_img }} by {{ library_size }} in size
    command: dd if=/dev/zero of={{ library_loc }}/{{ library_img }} bs=1 count=0 seek={{ library_size }}

  - name: Check ext4 filesystem inside container
    command: e2fsck -y -f {{ library_loc }}/{{ library_img }}

  - name: Resize filesystem inside container
    command: resize2fs -f {{ library_loc }}/{{ library_img }}
  when: library_base_url is defined or library_base_path is defined

- name: Test for {{ library_loc }}/{{ library_img }}
  command: test -f {{ library_loc }}/{{ library_img }}
  failed_when: False
  register: library_img_present

- name: Debug library_img_present
  debug:
    var: library_img_present

- block:
  - name: Create new container image to hold /library of {{ library_size }} in size
    command: dd if=/dev/zero of={{ library_loc }}/{{ library_img }} bs=1 count=0 seek={{ library_size }}

  - name: Create ext4 filesystem inside new container
    command: mkfs.ext4 {{ library_loc }}/{{ library_img }}
  when: not library_img_present.rc == 0 and library_url is undefined
  #end block

# rsync over ssh for private collections?
- name: Retrieve {{ library_url }} to {{ library_loc }}/{{ library_img }}
  command: wget -c {{ library_url }} -O {{ library_loc }}/{{ library_img }}
  when: library_url is defined

- name: Create /library mountpoint
  file:
    path: /library
    state: directory

- name: Check ext4 filesystem inside container
  command: e2fsck -y -f {{ library_loc }}/{{ library_img }}

- name: Clear old fstab entries for /library
  command: sed -i "/library/d" /etc/fstab

- name: Create new fstab entry
  lineinfile:
    path: /etc/fstab
    state: present
    line: '{{ library_loc }}/{{ library_img }}	/library	ext4	loop	0 0'

- name: Mount {{ library_loc }}/{{ library_img }} at /library
  command: mount -a

# fresh installs are right after this task, no need to run during install but we want /library/* directories if called from runrole
#- name: Create filesystem layout in /library when in runrole
#  include_tasks: roles/2-common/tasks/fl.yml
#  when: iiab_stage|int == 9
