- block:
  - name: test that {{ library_loc }} && {{ library_img }} are defined
    debug:
      msg: "VARIABLE MUST BE DEFINED: '{{ library_loc }} && {{ library_img }}' NEEDS A PROPER VALUE e.g. IN: /etc/iiab/local_vars.yml"
  - meta: end_play
  when: library_img is undefined or library_loc is undefined

- name: Create /library mountpoint
  file:
    path: /library
    state: directory

- name: stop services on /library
  systemd:
    name: "{{ item }}"
    state: stopped
  with_items:
  - kiwix-serve.service
  - kalite-serve.service
  when: iiab_stage|int == 9

# doesn't need conditional just looks better skipping, when the mountpoint does not exsist yet on new installs
- name: Unmount /library
  command: umount /library
  failed_when: False
  when: iiab_stage|int == 9

- name: Retrieve {{ library_base_url }} to {{ library_loc }}/{{ library_img }}
  command: wget -c {{ library_base_url }} -O {{ library_loc }}/{{ library_img }}
  when: library_base_url is defined

- name: Retrieve {{ library_base_path }} to {{ library_loc }}/{{ library_img }}
  command: cp {{ library_base_path }} {{ library_loc }}/{{ library_img }}
  when: library_base_path is defined

- name: Check ext4 filesystem inside container
  command: e2fsck -p -f {{ library_loc }}/{{ library_img }}
  register: fscheck1
  failed_when: fscheck1.rc not in [ 0, 1, 2 ]
  when: library_base_path is defined or library_base_url is defined

- name: Expand {{ library_img }} to {{ library_size }} in size
  command: dd if=/dev/zero of={{ library_loc }}/{{ library_img }} bs=1 count=0 seek={{ library_size }}

- name: Create ext4 filesystem inside new container
  command: mkfs.ext4 {{ library_loc }}/{{ library_img }}
  when: library_base_path is undefined and library_base_url is undefined

- name: Resize filesystem inside container
  command: resize2fs -f {{ library_loc }}/{{ library_img }}
  #when: library_base_path is defined or library_base_url is defined

- name: Check ext4 filesystem inside container
  command: e2fsck -p -f {{ library_loc }}/{{ library_img }}
  register: fscheck2
  failed_when: fscheck2.rc not in [ 0, 1, 2 ]

- name: Clear old fstab entries for /library
  command: sed -i "/library/d" /etc/fstab

- name: Create new fstab entry
  lineinfile:
    path: /etc/fstab
    state: present
    line: '{{ library_loc }}/{{ library_img }}	/library	ext4	loop	0 0'

- name: Mount {{ library_loc }}/{{ library_img }} at /library
  command: mount -a

- name: stop services on /library
  systemd:
    name: "{{ item }}"
    state: started
  with_items:
  - kiwix-serve.service
  - kalite-serve.service
  when: iiab_stage|int == 9

# fresh installs are right after this task, no need to run during install but we want /library/* directories if called from runrole
#- name: Create filesystem layout in /library when in runrole
#  include_tasks: roles/2-common/tasks/fl.yml
#  when: iiab_stage|int == 9
