- block:
  - name: test that {{ library_loc }} && {{ library_name }} && {{ has_ext_disk }} are defined
    debug:
      msg: "VARIABLE MUST BE DEFINED: '{{ library_loc }} && {{ library_name }}' && {{ has_ext_disk }} NEEDS A PROPER VALUE e.g. IN: /etc/iiab/local_vars.yml"
  - meta: end_play
  when: library_name is undefined or library_loc is undefined or has_ext_disk is undefined

- name: Assert that has_ext_disk is of type boolean (NOT type string, which can invert logic!)
  assert:
    that: "{{ has_ext_disk }} | type_debug == 'bool'"
    fail_msg: "VARIABLE MUST BE BOOLEAN True/False IN: /etc/iiab/local_vars.yml"
    quiet: yes

- name: Create /library mountpoints
  file:
    path: "{{ item }}"
    state: directory
  with_items:
  - /library
  - /library-ext

- name: Stop services hosted on /library
  systemd:
    name: "{{ item }}"
    state: stopped
  with_items:
  - kiwix-serve.service
  - kalite-serve.service
  when: iiab_stage|int == 9
  ignore_errors: True

# doesn't need conditional just looks better skipping, when the mountpoint does not exsist yet on new installs
- name: Unmount /library
  command: umount /library*
  failed_when: False
  when: iiab_stage|int == 9

- name: Clear old fstab entries for /library
  command: sed -i "/library/d" /etc/fstab

- name: Create ext4 filesystem inside new partitioned container
  include_tasks: fresh_container.yml
  when: library_base_path is undefined and library_base_url is undefined and not has_ext_disk

- name: Retrieve {{ library_base_url }} to {{ library_target }}
  command: wget -c {{ library_base_url }} -O {{ library_target }}
  when: library_base_url is defined and not has_ext_disk

- name: Retrieve {{ library_base_path }} to {{ library_target }}
  command: cp {{ library_base_path }} {{ library_target }}
  when: library_base_path is defined and not has_ext_disk

- name: Prepare pre-canned image
  include_tasks: pre-canned.yml
  when: (library_base_path is defined or library_base_url is defined) and not has_ext_disk

- name: Add fstab and release loop device
  block:
  - name: Create /library-ext fstab entry
    lineinfile:
      path: /etc/fstab
      state: present
      line: '{{ library_target }}	/library-ext	ext4	loop,offset=1048576	0 0'

  - name: Release loop device
    command: losetup -D {{ library_target }}
  when: not has_ext_disk

- name: Prepare external device
  block:
  - name: Create fstab entry for external /library-ext using label
    lineinfile:
      path: /etc/fstab
      state: present
      line: 'LABEL={{ library_name }}  /library-ext  ext4  defaults,nofail  0  0'

  - name: Find {{ library_name }} label of external device
    shell: lsblk -no pkname $(blkid --label {{ library_name }})
    register: ext_dev

  - name: Use pre-canned image to populate external drive
    block:
    - name: Write {{ library_base_path }} to {{ ext_dev.stdout }}
      command: dd if={{ library_base_path }} of={{ ext_dev.stdout }}

    - name: Resize external device partition
      command: growpart {{ ext_dev.stdout }} 1

    - name: Resize filesystem on first partition
      command: resize2fs -f {{ ext_dev.stdout }}p1
    when: library_base_path is defined

  - name: Check ext4 filesystem on external drive
    command: e2fsck -p -f {{ ext_dev.stdout }}p1
    register: fscheck2
    failed_when: fscheck2.rc not in [ 0, 1, 2 ]
  when: has_ext_disk

- name: Mounting /library-ext
  command: mount -a

- name: Create /library-ext/library
  file:
    path: /library-ext/library
    state: directory

- name: Create bindmount /library fstab entry
  lineinfile:
    path: /etc/fstab
    state: present
    line: /library-ext/library /library none defaults,bind,nofail 0 0

- name: Mounting /library
  command: mount -a

- name: Start services hosted on /library
  systemd:
    name: "{{ item }}"
    state: started
  with_items:
  - kiwix-serve.service
  - kalite-serve.service
  when: iiab_stage|int == 9
  ignore_errors: True

# fresh installs are right after this task, no need to run during install but we want /library/* directories if called from runrole
#- name: Create filesystem layout in /library when in runrole
#  include_tasks: roles/2-common/tasks/fl.yml
#  when: iiab_stage|int == 9
