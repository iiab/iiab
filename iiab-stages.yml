---
- hosts: all
  become: yes
  gather_facts: false

  vars_files:
    - roles/0-init/defaults/main.yml
    - vars/default_vars.yml
    # ansible-core 2.19 disallows (thankfully no longer needed!)
    #- vars/{{ ansible_local.local_facts.os_ver }}.yml
    - /etc/iiab/local_vars.yml
    - /etc/iiab/iiab_state.yml

  pre_tasks:
    - name: Gather facts -- when not is_proot (not Android)
      setup:
      when: not is_proot

    - name: Gather minimal facts -- when is_proot (Android)
      setup:
        gather_subset:
          - 'all'
          - '!hardware'
          - '!network'
      when: is_proot

    - name: Compute memory and swap facts when hardware subset is missing
      when: is_proot
      block:
        - name: Read memtotal and swaptotal from /proc/meminfo
          shell: |
            awk '
              /MemTotal:/ {mem=int($2/1024)}
              /SwapTotal:/ {swap=int($2/1024)}
              END {
                if (swap == "") swap = 0
                print mem, swap
              }
            ' /proc/meminfo
          register: memswap
          changed_when: false

        - name: Set fallback memtotal and swaptotal facts
          set_fact:
            iiab_memtotal_mb: "{{ memswap.stdout.split()[0] | int }}"
            iiab_swaptotal_mb: "{{ memswap.stdout.split()[1] | int }}"

  tasks:
    - name: 0-init
      include_role:
        name: 0-init

    - name: 1-prep
      include_role:
        name: 1-prep
      when: ansible_local.local_facts.stage | int < 1

    - name: 2-common
      include_role:
        name: 2-common
      when: ansible_local.local_facts.stage | int < 2

    - name: 3-base-server
      include_role:
        name: 3-base-server
      when: ansible_local.local_facts.stage | int < 3

    - name: 4-server-options
      include_role:
        name: 4-server-options
      when: ansible_local.local_facts.stage | int < 4

    - name: 5-xo-services
      include_role:
        name: 5-xo-services
      when: ansible_local.local_facts.stage | int < 5

    - name: 6-generic-apps
      include_role:
        name: 6-generic-apps
      when: ansible_local.local_facts.stage | int < 6

    - name: 7-edu-apps
      include_role:
        name: 7-edu-apps
      when: ansible_local.local_facts.stage | int < 7

    - name: 8-mgmt-tools
      include_role:
        name: 8-mgmt-tools
      when: ansible_local.local_facts.stage | int < 8

    - name: 9-local-addons
      include_role:
        name: 9-local-addons
      when: ansible_local.local_facts.stage | int < 9

    - name: Network
      include_role:
        name: network
