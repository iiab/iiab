name: 'Build RaspberryPi OS sdcard image'

concurrency:
  group: deploy_environment
  cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  # schedule:
    # Runs every Monday at 2:00 PM UTC
    # - cron: '0 14 * * 1'

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    environment:
      name: deploy
    strategy:
      matrix:
        include:
          - edition: ContentReady
            config: vars/local_vars_none.yml
            working_image_size: 5000
          - edition: Small
            config: vars/local_vars_small.yml
            working_image_size: 15000
          - edition: Medium
            config: vars/local_vars_medium.yml
            working_image_size: 15000
          - edition: Large
            config: vars/local_vars_large.yml
            working_image_size: 20000
          # - edition: Medical
          #   config: vars/local_vars_none.yml
          #   # Maybe only possible self-hosted
          #   # https://github.com/marketplace/actions/maximize-build-disk-space-only-remove-unwanted-software#how-it-works
          #   working_image_size: 75000
          #   preset_id: en-medical
    steps:
      - uses: actions/checkout@v6
        with:
          path: iiab
          fetch-depth: 0  # should be a full copy for updating later via git pull

      - uses: actions/checkout@v6
        with:
          repository: chapmanjacobd/nspawn-loop
          path: nspawn-loop

      - name: Download RaspberryPi OS
        working-directory: nspawn-loop
        run: sudo ./mount.sh https://downloads.raspberrypi.org/raspios_lite_arm64_latest ${{ matrix.working_image_size || 10000 }}

      - name: Build image
        working-directory: nspawn-loop
        run: |
          sudo -E bash << 'EOF'
          set -euo pipefail

          STATE_FILE=$(find . -maxdepth 1 -name "*.state" | head -n 1)
          source "$STATE_FILE"

          VERSION=$(grep '^iiab_base_ver:' ../iiab/vars/default_vars.yml | awk '{print $2}')
          echo "IIAB_BASE_VERSION=$VERSION" >> $GITHUB_ENV
          DATE=$(date +'%y%m%d')
          OS="raspios"
          EDITION="${{ matrix.edition }}"
          HASH=$(git -C ../iiab rev-parse --short HEAD)
          IMG_NAME="iiab-$VERSION-$DATE-$OS-$EDITION-$HASH.img"
          echo "IMG_NAME=$IMG_NAME" >> $GITHUB_ENV

          mkdir -p "$MOUNT_DIR/opt/iiab"
          cp -R --preserve=mode,timestamps,links ../iiab "$MOUNT_DIR/opt/iiab/"

          mkdir -p "$MOUNT_DIR/etc/iiab"
          cp --preserve=mode,timestamps ../iiab/${{ matrix.config }} "$MOUNT_DIR/etc/iiab/local_vars.yml"

          echo "rpi_image: True" >> "$MOUNT_DIR/etc/iiab/local_vars.yml"

          if ! command -v expect &>/dev/null; then
              apt-get update && apt-get install -y expect
          fi
          if ! command -v systemd-nspawn &> /dev/null; then
              apt-get update && apt-get install -y systemd-container
          fi

          systemctl is-active --quiet systemd-networkd || systemctl start systemd-networkd
          systemctl is-active --quiet systemd-resolved || systemctl start systemd-resolved

          # Explicitly allow forwarding for systemd-nspawn virtual interfaces
          sysctl -w net.ipv4.ip_forward=1
          EXT_IF=$(ip route | grep default | awk '{print $5}' | head -n1)
          iptables -t nat -A POSTROUTING -o "$EXT_IF" -j MASQUERADE
          iptables -A FORWARD -i ve-+ -o "$EXT_IF" -j ACCEPT
          iptables -A FORWARD -i "$EXT_IF" -o ve-+ -m state --state RELATED,ESTABLISHED -j ACCEPT

          # Manually setting DNS can help avoid host loopback/127.0.0.53 issues
          # echo "nameserver 1.1.1.1" >> "$MOUNT_DIR/etc/resolv.conf"

          sed 's/^          //' << 'EOF_PRESET' > "$MOUNT_DIR/root/install_preset.sh"
          #!/bin/bash
          set -euo pipefail
          cd /opt/admin/cmdsrv

          scripts/get_kiwix_catalog
          scripts/get_oer2go_catalog

          if [ -n "${{ matrix.preset_id }}" ]; then
              iiab-cmdsrv-ctl 'INST-PRESETS {"preset_id":"${{ matrix.preset_id }}"}'
          fi

          rm -f /root/install_preset.sh
          EOF_PRESET
          chmod +x "$MOUNT_DIR/root/install_preset.sh"

          systemd-firstboot --root="$MOUNT_DIR" --delete-root-password --force
          export MOUNT_DIR
          sed 's/^          //' << 'EXPECT_EOF' | expect
          set timeout 7200

          spawn systemd-nspawn -q --network-veth --resolv-conf=off -D $env(MOUNT_DIR) -M box --boot
          expect "login: " { send "root\r" }

          expect -re {#\s?$} { send "apt update\r" }
          expect -re {#\s?$} { send "mkdir -p /etc/initramfs-tools/conf.d && echo 'MODULES=most' > /etc/initramfs-tools/conf.d/nspawn.conf\r" }
          expect -re {#\s?$} { send "DEBIAN_FRONTEND=noninteractive apt upgrade -y\r" }

          expect -re {#\s?$} { send "curl -fLo /usr/sbin/iiab https://raw.githubusercontent.com/iiab/iiab-factory/master/iiab\r" }
          expect -re {#\s?$} { send "chmod 0755 /usr/sbin/iiab\r" }
          expect -re {#\s?$} { send "/usr/sbin/iiab --risky\r" }
          expect {
              timeout { puts "\nTimed out waiting for final confirmation prompt"; exit 1 }
              "photographed" { send "\r" }
          }
          # forced reboot
          expect "login: " { send "root\r" }

          expect -re {#\s?$} { send "/root/install_preset.sh\r" }

          expect -re {#\s?$} { send "usermod --lock --expiredate=1 root\r" }
          expect -re {#\s?$} { send "usermod --lock --expiredate=1 pi\r" }
          # PR 4236 may deprecate the next line
          expect -re {#\s?$} { send "systemctl stop systemd-networkd-wait-online.service\r" }
          expect -re {#\s?$} { send "shutdown now\r" }
          expect eof
          EXPECT_EOF

          EOF

      - name: Shrink image
        working-directory: nspawn-loop
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          sudo -E bash << 'EOF'
          set -euo pipefail

          STATE_FILE=$(find . -maxdepth 1 -name "*.state" | head -n 1)
          source "$STATE_FILE"

          # Add image metadata
          echo "$IMG_NAME" > "$MOUNT_DIR/.iiab-image"
          echo "Build: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$MOUNT_DIR/.iiab-image"
          gh pr list --repo ${{ github.repository }} --commit $(git -C ../iiab rev-parse HEAD) --json number,url --jq '.[0] | "PR #\(.number): \(.url)"' >> "$MOUNT_DIR/.iiab-image" 2>/dev/null || true
          git -C ../iiab rev-parse --abbrev-ref HEAD >> "$MOUNT_DIR/.iiab-image"
          git -C ../iiab remote -v >> "$MOUNT_DIR/.iiab-image"
          git -C ../iiab log -1 >> "$MOUNT_DIR/.iiab-image"

          # Remove image-specific configuration
          rm -f "$MOUNT_DIR/etc/initramfs-tools/conf.d/nspawn.conf"
          sed -i '/rpi_image: True/d' "$MOUNT_DIR/etc/iiab/local_vars.yml"

          echo uninitialized > "$MOUNT_DIR/etc/machine-id"
          rm -f "$MOUNT_DIR/etc/iiab/uuid"
          rm -f "$MOUNT_DIR/var/swap"
          ./shrink.sh "$STATE_FILE" 1800

          mv "$IMG_FILE" "$IMG_NAME"
          EOF

      # - name: Compress image
      #   working-directory: nspawn-loop
      #   run: xz -v -9 -T0 --stdout "$IMG_NAME" > "$IMG_NAME.xz"

      # - name: Upload to Internet Archive
      #   working-directory: nspawn-loop
      #   env:
      #     IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
      #     IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
      #   run: |
      #     set -euo pipefail
      #     pipx install internetarchive
      #     export PATH="$PATH:$HOME/.local/bin"

      #     # Configure IA credentials using S3 keys
      #     mkdir -p ~/.config
      #     printf "[s3]\naccess = %s\nsecret = %s\n" "$IA_ACCESS_KEY" "$IA_SECRET_KEY" > ~/.config/ia.ini
      #     chmod 600 ~/.config/ia.ini

      #     # Construct a stable identifier for "updating" (no dots allowed)
      #     # Format: iiab-raspios-edition (e.g., iiab-raspios-contentready)
      #     ID="iiab-raspios-$(echo "${{ matrix.edition }}" | tr '[:upper:]' '[:lower:]' | tr '.' '-' | tr '_' '-')"

      #     echo "Calculating hashes for $IMG_NAME..."
      #     IMG_SIZE=$(stat -c%s "$IMG_NAME")
      #     IMG_SHA256=$(sha256sum "$IMG_NAME" | awk '{print $1}')
      #     rm -f "$IMG_NAME"
      #     XZ_SIZE=$(stat -c%s "$IMG_NAME.xz")
      #     XZ_MD5=$(md5sum "$IMG_NAME.xz" | awk '{print $1}')

      #     echo "Deleting previous versions of $ID"
      #     ia delete "$ID" --all -H "x-archive-keep-old-version:0" || true

      #     echo "Uploading $IMG_NAME.xz to Internet Archive as item: $ID"
      #     ia upload "$ID" "$IMG_NAME.xz" \
      #       --no-derive --verify --retries 3 --sleep 300 \
      #       --metadata="mediatype:software" \
      #       --metadata="collection:internetinabox" \
      #       --metadata="title:Internet in a Box Raspberry Pi Image - ${{ matrix.edition }} (Latest)" \
      #       --metadata="language:eng" \
      #       --metadata="description:Internet in a Box $IIAB_BASE_VERSION Raspberry Pi Build<BR>Edition: ${{ matrix.edition }}<BR>Filename: $IMG_NAME<BR>Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
      #       --metadata="creator:Internet in a Box" \
      #       --metadata="subject:rpi" \
      #       --metadata="subject:iiab" \
      #       --metadata="subject:${{ matrix.edition }}" \
      #       --metadata="licenseurl:http://creativecommons.org/licenses/by-sa/4.0/" \
      #       --metadata="img_sha256:$IMG_SHA256" \
      #       --metadata="img_size:$IMG_SIZE" \
      #       --metadata="xz_size:$XZ_SIZE" \
      #       --metadata="xz_md5:$XZ_MD5"
