name: 'Build RaspberryPi OS sdcard image'

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  # schedule:
    # Runs every Monday at 2:00 PM UTC
    # - cron: '0 14 * * 1'

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        include:
          - edition: ContentReady
            config: vars/local_vars_none.yml
          # - edition: Small
          #   config: vars/local_vars_small.yml
          # - edition: Medium
          #   config: vars/local_vars_medium.yml
          # - edition: Large
          #   config: vars/local_vars_large.yml
    steps:
      - uses: actions/checkout@v6
        with:
          path: iiab
          fetch-depth: 0  # should be a full copy for updating later via git pull

      - uses: actions/checkout@v6
        with:
          repository: chapmanjacobd/nspawn-loop
          path: nspawn-loop

      - name: Download RaspberryPi OS
        working-directory: nspawn-loop
        run: sudo ./mount.sh https://downloads.raspberrypi.org/raspios_lite_arm64_latest 10000

      - name: Build image
        working-directory: nspawn-loop
        run: |
          sudo -E bash << 'EOF'
          set -euo pipefail

          STATE_FILE=$(find . -maxdepth 1 -name "*.state" | head -n 1)
          source "$STATE_FILE"

          VERSION=$(grep '^iiab_base_ver:' ../iiab/vars/default_vars.yml | awk '{print $2}')
          DATE=$(date +'%y%m%d')
          OS="raspios"
          EDITION="${{ matrix.edition }}"
          HASH=$(git -C ../iiab rev-parse --short HEAD)
          IMG_NAME="iiab-$VERSION-$DATE-$OS-$EDITION-$HASH.img"
          echo "IMG_NAME=$IMG_NAME" >> $GITHUB_ENV

          mkdir -p "$MOUNT_DIR/opt/iiab"
          cp -R --preserve=mode,timestamps,links ../iiab "$MOUNT_DIR/opt/iiab/"

          mkdir -p "$MOUNT_DIR/etc/iiab"
          cp --preserve=mode,timestamps ../iiab/${{ matrix.config }} "$MOUNT_DIR/etc/iiab/local_vars.yml"

          echo "rpi_image: True" >> "$MOUNT_DIR/etc/iiab/local_vars.yml"

          if ! command -v expect &>/dev/null; then
              apt-get update && apt-get install -y expect
          fi
          if ! command -v systemd-nspawn &> /dev/null; then
              apt-get update && apt-get install -y systemd-container
          fi

          systemctl is-active --quiet systemd-networkd || systemctl start systemd-networkd
          systemctl is-active --quiet systemd-resolved || systemctl start systemd-resolved

          # Explicitly allow forwarding for systemd-nspawn virtual interfaces
          sysctl -w net.ipv4.ip_forward=1
          EXT_IF=$(ip route | grep default | awk '{print $5}' | head -n1)
          iptables -t nat -A POSTROUTING -o "$EXT_IF" -j MASQUERADE
          iptables -A FORWARD -i ve-+ -o "$EXT_IF" -j ACCEPT
          iptables -A FORWARD -i "$EXT_IF" -o ve-+ -m state --state RELATED,ESTABLISHED -j ACCEPT

          # Manually setting DNS can help avoid host loopback/127.0.0.53 issues
          # echo "nameserver 1.1.1.1" >> "$MOUNT_DIR/etc/resolv.conf"

          sed 's/^          //' << 'EOF_PRESET' > "$MOUNT_DIR/root/install_preset.sh"
          #!/bin/bash
          set -euo pipefail
          cd /opt/admin/cmdsrv

          scripts/get_kiwix_catalog
          scripts/get_oer2go_catalog

          iiab-cmdsrv-ctl 'INST-PRESETS {"preset_id":"test"}'
          EOF_PRESET
          chmod +x "$MOUNT_DIR/root/install_preset.sh"

          systemd-firstboot --root="$MOUNT_DIR" --delete-root-password --force
          export MOUNT_DIR
          sed 's/^          //' << 'EXPECT_EOF' | expect
          set timeout 7200

          spawn systemd-nspawn -q --network-veth --resolv-conf=off -D $env(MOUNT_DIR) -M box --boot
          expect "login: " { send "root\r" }

          expect -re {#\s?$} { send "apt update\r" }
          expect -re {#\s?$} { send "mkdir -p /etc/initramfs-tools/conf.d && echo 'MODULES=most' > /etc/initramfs-tools/conf.d/nspawn.conf\r" }
          expect -re {#\s?$} { send "DEBIAN_FRONTEND=noninteractive apt upgrade -y\r" }

          expect -re {#\s?$} { send "curl -fLo /usr/sbin/iiab https://raw.githubusercontent.com/iiab/iiab-factory/master/iiab\r" }
          expect -re {#\s?$} { send "chmod 0755 /usr/sbin/iiab\r" }
          expect -re {#\s?$} { send "/usr/sbin/iiab --risky\r" }
          expect {
              timeout { puts "\nTimed out waiting for final confirmation prompt"; exit 1 }
              "photographed" { send "\r" }
          }
          # forced reboot
          expect "login: " { send "root\r" }

          expect -re {#\s?$} { send "/root/install_preset.sh\r" }

          expect -re {#\s?$} { send "usermod --lock --expiredate=1 root\r" }
          expect -re {#\s?$} { send "shutdown now\r" }
          expect eof
          EXPECT_EOF

          EOF

      - name: Shrink image
        working-directory: nspawn-loop
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          sudo -E bash << 'EOF'
          set -euo pipefail

          STATE_FILE=$(find . -maxdepth 1 -name "*.state" | head -n 1)
          source "$STATE_FILE"

          # Add image metadata
          echo "$IMG_NAME" > "$MOUNT_DIR/.iiab-image"
          echo "Build: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$MOUNT_DIR/.iiab-image"
          gh pr list --repo ${{ github.repository }} --commit $(git -C ../iiab rev-parse HEAD) --json number,url --jq '.[0] | "PR #\(.number): \(.url)"' >> "$MOUNT_DIR/.iiab-image" 2>/dev/null || true
          git -C ../iiab rev-parse --abbrev-ref HEAD >> "$MOUNT_DIR/.iiab-image"
          git -C ../iiab remote -v >> "$MOUNT_DIR/.iiab-image"
          git -C ../iiab log -1 >> "$MOUNT_DIR/.iiab-image"

          # Remove image-specific configuration
          rm -f "$MOUNT_DIR/etc/initramfs-tools/conf.d/nspawn.conf"
          sed -i '/rpi_image: True/d' "$MOUNT_DIR/etc/iiab/local_vars.yml"

          rm -f "$MOUNT_DIR/etc/iiab/uuid"
          ./shrink.sh "$STATE_FILE" 5000

          mv "$IMG_FILE" "$IMG_NAME"
          EOF

      - name: Upload image as artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.IMG_NAME }}
          path: nspawn-loop/${{ env.IMG_NAME }}
          if-no-files-found: error
          retention-days: 3
          compression-level: 9

      # - name: Compress image
      #   working-directory: nspawn-loop
      #   run: xz -v -9 -T0 --stdout "$IMG_NAME" > "$IMG_NAME.xz"

      # - name: Create GitHub Release
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     TAG="${{ env.IMG_NAME }}"
      #     TAG="${TAG%.img}"
      #     gh release create "$TAG" "nspawn-loop/${{ env.IMG_NAME }}.xz" \
      #       --title "$TAG" \
      #       --generate-notes
