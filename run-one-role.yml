---
- hosts: all
  become: yes
  gather_facts: false

  vars_files:
    - vars/default_vars.yml
    # ansible-core 2.19 disallows (thankfully not needed!)
    #- vars/{{ ansible_local.local_facts.os_ver }}.yml
    - /etc/iiab/local_vars.yml
    - /etc/iiab/iiab_state.yml

  tasks:
    - name: Detect proot environment early
      shell: |
        if [ -n "${ANDROID_ROOT}" ]; then
          echo true
        else
          echo false
        fi
      register: proot_probe
      changed_when: false
      failed_when: false

#    - debug:
#        var: proot_probe

    - name: Set is_proot_initial
      set_fact:
        is_proot_initial: "{{ (proot_probe.stdout | trim) == 'true' }}"

    - name: Gather minimal facts bootstrap (proot-safe)
      when: is_proot_initial
      setup:
        gather_subset:
          - 'all'
          - '!hardware'
          - '!network'

    - name: Gather default facts
      when: not is_proot_initial
      setup:

    - name: Compute memory and swap facts when hardware subset is missing
      when: ansible_facts['swaptotal_mb'] is not defined or ansible_facts['memtotal_mb'] is not defined
      block:
        - name: Read memtotal and swaptotal from /proc/meminfo
          shell: |
            awk '
              /MemTotal:/ {mem=int($2/1024)}
              /SwapTotal:/ {swap=int($2/1024)}
              END {
                if (swap == "") swap = 0
                print mem, swap
              }
            ' /proc/meminfo
          register: memswap
          changed_when: false

        - name: Set fallback memtotal and swaptotal facts (proot)
          set_fact:
            ansible_memtotal_mb: "{{ memswap.stdout.split()[0] | int }}"
            ansible_swaptotal_mb: "{{ memswap.stdout.split()[1] | int }}"

  roles:
    - { role: 0-init }
    - { role: "{{ role_to_run }}" }
