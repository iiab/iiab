---
- hosts: all
  become: yes
  gather_facts: false

  vars_files:
    - vars/default_vars.yml
    # ansible-core 2.19 disallows (thankfully not needed!)
    #- vars/{{ ansible_local.local_facts.os_ver }}.yml
    - /etc/iiab/local_vars.yml
    - /etc/iiab/iiab_state.yml

  pre_tasks:
    - name: Gather facts -- when not is_proot (not Android)
      setup:
      when: not is_proot

    - name: Gather minimal facts -- when is_proot (Android)
      setup:
        gather_subset:
          - 'all'
          - '!hardware'
          - '!network'
      when: is_proot

    - name: Compute memory and swap facts when hardware subset is missing
      when: is_proot
      block:
        - name: Read memtotal and swaptotal from /proc/meminfo
          shell: |
            awk '
              /MemTotal:/ {mem=int($2/1024)}
              /SwapTotal:/ {swap=int($2/1024)}
              END {
                if (swap == "") swap = 0
                print mem, swap
              }
            ' /proc/meminfo
          register: memswap
          changed_when: false

        - name: Set fallback memtotal and swaptotal facts
          set_fact:
            iiab_memtotal_mb: "{{ memswap.stdout.split()[0] | int }}"
            iiab_swaptotal_mb: "{{ memswap.stdout.split()[1] | int }}"

  roles:
    - { role: 0-init }
    - { role: "{{ role_to_run }}" }
